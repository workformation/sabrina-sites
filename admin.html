<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SABRINA Command Center V1.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* ============================================
           SABRINA COMMAND CENTER - DESIGN SYSTEM
           Version 1.0 - Executive Gold Theme
           ============================================ */
        
        :root {
            /* COULEURS PRINCIPALES */
            --gold: #D4AF37;
            --gold-light: #F4E4BC;
            --gold-dark: #B8960C;
            --gold-gradient: linear-gradient(135deg, #D4AF37 0%, #B8960C 100%);
            
            /* FONDS */
            --bg-deep: #0F172A;
            --bg-deep-light: #1E293B;
            --bg-secondary: #334155;
            --bg-card: #FFFFFF;
            --bg-main: #F8FAFC;
            --bg-hover: #F1F5F9;
            
            /* STATUTS */
            --success: #10B981;
            --success-bg: #D1FAE5;
            --warning: #F59E0B;
            --warning-bg: #FEF3C7;
            --danger: #EF4444;
            --danger-bg: #FEE2E2;
            --info: #3B82F6;
            --info-bg: #DBEAFE;
            
            /* TEXTES */
            --text-primary: #0F172A;
            --text-secondary: #64748B;
            --text-muted: #94A3B8;
            --text-inverse: #FFFFFF;
            
            /* BORDURES & OMBRES */
            --border: #E2E8F0;
            --border-light: #F1F5F9;
            --shadow-sm: 0 1px 2px rgba(15, 23, 42, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(15, 23, 42, 0.07), 0 2px 4px -1px rgba(15, 23, 42, 0.04);
            --shadow-lg: 0 10px 15px -3px rgba(15, 23, 42, 0.08), 0 4px 6px -2px rgba(15, 23, 42, 0.04);
            --shadow-xl: 0 20px 25px -5px rgba(15, 23, 42, 0.1), 0 10px 10px -5px rgba(15, 23, 42, 0.04);
            --shadow-gold: 0 4px 14px rgba(212, 175, 55, 0.35);
            
            /* DIMENSIONS */
            --sidebar-width: 280px;
            --sidebar-collapsed: 80px;
            --header-height: 72px;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            
            /* TRANSITIONS */
            --transition-fast: 150ms ease;
            --transition-base: 250ms ease;
            --transition-slow: 400ms ease;
        }

        /* RESET & BASE */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html { scroll-behavior: smooth; }
        
        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* ANIMATIONS */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(212, 175, 55, 0.3); }
            50% { box-shadow: 0 0 20px rgba(212, 175, 55, 0.6); }
        }

        .animate-fade { animation: fadeIn var(--transition-base) ease-out; }
        .animate-slide-up { animation: slideInUp var(--transition-base) ease-out; }
        .animate-slide-left { animation: slideInLeft var(--transition-base) ease-out; }
        .animate-slide-right { animation: slideInRight var(--transition-base) ease-out; }
        .animate-scale { animation: scaleIn var(--transition-base) ease-out; }
        
        .stagger-1 { animation-delay: 50ms; }
        .stagger-2 { animation-delay: 100ms; }
        .stagger-3 { animation-delay: 150ms; }
        .stagger-4 { animation-delay: 200ms; }
        .stagger-5 { animation-delay: 250ms; }

        /* SCROLLBAR CUSTOM */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-main); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* ============================================
           LOGIN SCREEN
           ============================================ */
        .login-container {
            min-height: 100vh;
            display: flex;
            background: linear-gradient(135deg, var(--bg-deep) 0%, var(--bg-deep-light) 50%, var(--bg-secondary) 100%);
            position: relative;
            overflow: hidden;
        }
        
        .login-container::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 80%;
            height: 200%;
            background: radial-gradient(ellipse, rgba(212, 175, 55, 0.08) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .login-container::after {
            content: '';
            position: absolute;
            bottom: -30%;
            left: -10%;
            width: 50%;
            height: 100%;
            background: radial-gradient(ellipse, rgba(212, 175, 55, 0.05) 0%, transparent 60%);
            pointer-events: none;
        }

        .login-left {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 60px 80px;
            position: relative;
            z-index: 1;
        }

        .login-brand {
            margin-bottom: 20px;
        }
        
        .login-brand h1 {
            font-family: 'Playfair Display', serif;
            font-size: 4rem;
            font-weight: 700;
            color: var(--text-inverse);
            letter-spacing: -1px;
            margin-bottom: 8px;
        }
        
        .login-brand h1 span {
            color: var(--gold);
        }
        
        .login-brand .tagline {
            font-size: 1.25rem;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 400;
        }
        
        .login-brand .version {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--gold);
            margin-left: 12px;
            font-weight: 600;
        }

        .login-features {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 50px;
            max-width: 500px;
        }

        .login-feature {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 20px 24px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.06);
            transition: all var(--transition-base);
            cursor: default;
        }
        
        .login-feature:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateX(8px);
            border-color: rgba(212, 175, 55, 0.2);
        }

        .login-feature-icon {
            width: 50px;
            height: 50px;
            background: var(--gold-gradient);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .login-feature-content h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-inverse);
            margin-bottom: 4px;
        }
        
        .login-feature-content p {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.5;
        }

        .login-stats {
            display: flex;
            gap: 40px;
            margin-top: 60px;
            padding-top: 40px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .login-stat {
            text-align: left;
        }
        
        .login-stat-value {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--gold);
            line-height: 1;
        }
        
        .login-stat-label {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 8px;
        }

        .login-right {
            width: 520px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            position: relative;
            z-index: 1;
        }

        .login-card {
            width: 100%;
            max-width: 420px;
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 48px 40px;
            box-shadow: var(--shadow-xl);
            animation: scaleIn var(--transition-slow) ease-out;
        }

        .login-card h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.875rem;
            text-align: center;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .login-card > p {
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 32px;
            font-size: 0.9375rem;
        }

        .login-divider {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 28px 0;
        }
        
        .login-divider::before,
        .login-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }
        
        .login-divider span {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
        }

        .demo-accounts {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .demo-account {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 18px;
            background: var(--bg-main);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            border: 2px solid transparent;
        }
        
        .demo-account:hover {
            background: var(--bg-hover);
            border-color: var(--gold);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .demo-account-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-inverse);
            flex-shrink: 0;
        }
        
        .demo-account-avatar.admin {
            background: linear-gradient(135deg, var(--bg-deep) 0%, var(--bg-secondary) 100%);
        }
        
        .demo-account-avatar.client {
            background: var(--gold-gradient);
            color: var(--bg-deep);
        }

        .demo-account-info {
            flex: 1;
            min-width: 0;
        }
        
        .demo-account-info strong {
            display: block;
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .demo-account-info span {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .demo-account-arrow {
            font-size: 1.25rem;
            color: var(--text-muted);
            transition: all var(--transition-fast);
        }
        
        .demo-account:hover .demo-account-arrow {
            color: var(--gold);
            transform: translateX(4px);
        }

        .login-footer {
            margin-top: 32px;
            text-align: center;
        }
        
        .login-footer p {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }
        
        .login-footer a {
            color: var(--gold-dark);
            text-decoration: none;
            font-weight: 500;
        }
        
        .login-footer a:hover {
            text-decoration: underline;
        }

        /* ============================================
           APP LAYOUT
           ============================================ */
        .app-container {
            display: none;
            min-height: 100vh;
        }
        
        .app-container.active {
            display: flex;
        }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-deep);
            color: var(--text-inverse);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
            transition: width var(--transition-base);
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .sidebar-brand-logo {
            width: 40px;
            height: 40px;
            background: var(--gold-gradient);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--bg-deep);
        }
        
        .sidebar-brand-text {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .sidebar-brand-text span {
            color: var(--gold);
        }

        .sidebar-subtitle {
            font-size: 0.6875rem;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding-left: 52px;
        }

        .sidebar-nav {
            flex: 1;
            padding: 20px 12px;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 28px;
        }

        .nav-section-title {
            font-size: 0.6875rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: rgba(255, 255, 255, 0.35);
            padding: 8px 16px;
            margin-bottom: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            margin-bottom: 4px;
            color: rgba(255, 255, 255, 0.65);
            position: relative;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-inverse);
        }
        
        .nav-item.active {
            background: rgba(212, 175, 55, 0.15);
            color: var(--gold);
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 24px;
            background: var(--gold);
            border-radius: 0 3px 3px 0;
        }

        .nav-item-icon {
            font-size: 1.25rem;
            width: 28px;
            text-align: center;
            flex-shrink: 0;
        }

        .nav-item-text {
            font-size: 0.9375rem;
            font-weight: 500;
        }

        .nav-item-badge {
            margin-left: auto;
            padding: 2px 8px;
            background: var(--danger);
            color: white;
            font-size: 0.6875rem;
            font-weight: 700;
            border-radius: 10px;
        }

        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .user-menu:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .user-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: var(--gold-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            color: var(--bg-deep);
            flex-shrink: 0;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }
        
        .user-name {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text-inverse);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-role {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .user-menu-icon {
            color: rgba(255, 255, 255, 0.4);
            font-size: 1rem;
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--bg-main);
        }

        /* HEADER */
        .header {
            height: var(--header-height);
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-title {
            font-size: 1.375rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .header-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .header-breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        
        .header-breadcrumb a {
            color: var(--text-secondary);
            text-decoration: none;
        }
        
        .header-breadcrumb a:hover {
            color: var(--gold-dark);
        }
        
        .header-breadcrumb .current {
            color: var(--text-primary);
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-search {
            position: relative;
        }
        
        .header-search input {
            width: 280px;
            padding: 10px 16px 10px 42px;
            font-size: 0.875rem;
            background: var(--bg-main);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            outline: none;
            transition: all var(--transition-fast);
        }
        
        .header-search input:focus {
            background: var(--bg-card);
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }
        
        .header-search input::placeholder {
            color: var(--text-muted);
        }
        
        .header-search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1rem;
        }

        .header-icon-btn {
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 1.25rem;
            transition: all var(--transition-fast);
            position: relative;
        }
        
        .header-icon-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .header-icon-btn .badge {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 18px;
            height: 18px;
            background: var(--danger);
            color: white;
            font-size: 0.625rem;
            font-weight: 700;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--success-bg);
            border-radius: var(--radius-md);
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--success);
        }
        
        .connection-status.disconnected {
            background: var(--danger-bg);
            color: var(--danger);
        }
        
        .connection-status.loading {
            background: var(--warning-bg);
            color: var(--warning);
        }
        
        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        
        .connection-status:not(.disconnected) .connection-dot {
            animation: pulse 2s infinite;
        }

        /* PAGE CONTENT */
        .page-content {
            flex: 1;
            padding: 32px;
        }

        .page-header {
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .page-header-left h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .page-header-left p {
            color: var(--text-secondary);
            font-size: 0.9375rem;
        }

        .page-header-actions {
            display: flex;
            gap: 12px;
        }

        /* ============================================
           COMPONENTS
           ============================================ */
        
        /* BUTTONS */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            font-size: 0.9375rem;
            font-weight: 600;
            font-family: inherit;
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            text-decoration: none;
            white-space: nowrap;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--gold-gradient);
            color: var(--bg-deep);
            box-shadow: var(--shadow-gold);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.45);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: var(--bg-hover);
            border-color: var(--text-muted);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            padding: 10px 16px;
        }
        
        .btn-ghost:hover:not(:disabled) {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #DC2626;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #059669;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.8125rem;
        }

        .btn-lg {
            padding: 16px 32px;
            font-size: 1rem;
        }

        .btn-icon {
            width: 42px;
            height: 42px;
            padding: 0;
        }

        .btn-block {
            width: 100%;
        }

        /* CARDS */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            overflow: hidden;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .card-subtitle {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .card-body {
            padding: 24px;
        }

        .card-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-light);
            background: var(--bg-main);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* BADGES */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 20px;
        }

        .badge-success { background: var(--success-bg); color: var(--success); }
        .badge-warning { background: var(--warning-bg); color: var(--warning); }
        .badge-danger { background: var(--danger-bg); color: var(--danger); }
        .badge-info { background: var(--info-bg); color: var(--info); }
        .badge-neutral { background: var(--bg-main); color: var(--text-secondary); }
        .badge-gold { background: var(--gold-light); color: var(--gold-dark); }

        /* FORMS */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .form-label .required {
            color: var(--danger);
            margin-left: 2px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            font-size: 0.9375rem;
            font-family: inherit;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
            outline: none;
            color: var(--text-primary);
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }
        
        .form-input::placeholder,
        .form-textarea::placeholder {
            color: var(--text-muted);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-hint {
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .form-error {
            font-size: 0.8125rem;
            color: var(--danger);
            margin-top: 6px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        /* GRIDS */
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; }

        /* STATS */
        .stat-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--border-light);
            transition: all var(--transition-fast);
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .stat-card-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .stat-card-icon.gold { background: var(--gold-light); }
        .stat-card-icon.blue { background: var(--info-bg); }
        .stat-card-icon.green { background: var(--success-bg); }
        .stat-card-icon.red { background: var(--danger-bg); }

        .stat-card-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8125rem;
            font-weight: 600;
        }
        
        .stat-card-trend.up { color: var(--success); }
        .stat-card-trend.down { color: var(--danger); }

        .stat-card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .stat-card-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* TABLES */
        .table-container {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }

        .table th {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            background: var(--bg-main);
        }

        .table tbody tr {
            transition: background var(--transition-fast);
        }
        
        .table tbody tr:hover {
            background: var(--bg-hover);
        }

        .table td {
            font-size: 0.9375rem;
            color: var(--text-primary);
        }

        /* TOAST */
        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            padding: 16px 20px;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideInRight var(--transition-base);
            min-width: 320px;
            max-width: 450px;
        }
        
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.warning { border-left: 4px solid var(--warning); }
        .toast.info { border-left: 4px solid var(--info); }

        .toast-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        
        .toast.success .toast-icon { color: var(--success); }
        .toast.error .toast-icon { color: var(--danger); }
        .toast.warning .toast-icon { color: var(--warning); }
        .toast.info .toast-icon { color: var(--info); }

        .toast-content {
            flex: 1;
            min-width: 0;
        }

        .toast-title {
            font-weight: 600;
            font-size: 0.9375rem;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .toast-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0;
            line-height: 1;
        }
        
        .toast-close:hover {
            color: var(--text-primary);
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-base);
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            width: 90%;
            max-width: 560px;
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.9) translateY(20px);
            transition: transform var(--transition-base);
        }
        
        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 1.5rem;
            transition: all var(--transition-fast);
        }
        
        .modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(90vh - 160px);
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-light);
            background: var(--bg-main);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-state p {
            color: var(--text-secondary);
            max-width: 400px;
            margin: 0 auto;
        }

        /* SKELETON LOADER */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-hover) 25%, var(--bg-main) 50%, var(--bg-hover) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-sm);
        }

        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
        }
        
        .skeleton-text:last-child {
            width: 70%;
        }

        .skeleton-title {
            height: 24px;
            width: 50%;
            margin-bottom: 16px;
        }

        .skeleton-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
        }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 1024px) {
            .grid-3 { grid-template-columns: repeat(2, 1fr); }
            .login-left { padding: 40px; }
            .login-stats { flex-wrap: wrap; gap: 24px; }
        }

        @media (max-width: 768px) {
            .login-container { flex-direction: column; }
            .login-left { padding: 40px 24px; }
            .login-right { width: 100%; padding: 24px; }
            .login-brand h1 { font-size: 3rem; }
            .sidebar { display: none; }
            .main-content { margin-left: 0; }
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
            .header { padding: 0 16px; }
            .page-content { padding: 20px 16px; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Modal Container -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modalContent"></div>
    </div>

    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-left">
            <div class="login-brand">
                <h1>SABRINA<span>.</span></h1>
                <p class="tagline">Command Center <span class="version">V1.0</span></p>
            </div>
            
            <div class="login-features">
                <div class="login-feature animate-slide-up stagger-1">
                    <div class="login-feature-icon">üîó</div>
                    <div class="login-feature-content">
                        <h3>Connect√© √† n8n en temps r√©el</h3>
                        <p>Vos workflows sont synchronis√©s automatiquement. Cr√©ez, modifiez, activez vos modules IA directement.</p>
                    </div>
                </div>
                
                <div class="login-feature animate-slide-up stagger-2">
                    <div class="login-feature-icon">üß†</div>
                    <div class="login-feature-content">
                        <h3>M√©moire persistante</h3>
                        <p>SABRINA se souvient de toutes vos conversations et adapte ses r√©ponses √† votre contexte.</p>
                    </div>
                </div>
                
                <div class="login-feature animate-slide-up stagger-3">
                    <div class="login-feature-icon">üìä</div>
                    <div class="login-feature-content">
                        <h3>Cockpit business complet</h3>
                        <p>KPIs, pipeline, clients, audits, devis, factures - tout votre business en un coup d'≈ìil.</p>
                    </div>
                </div>
            </div>
            
            <div class="login-stats animate-fade stagger-4">
                <div class="login-stat">
                    <div class="login-stat-value" id="statModules">--</div>
                    <div class="login-stat-label">Modules actifs</div>
                </div>
                <div class="login-stat">
                    <div class="login-stat-value" id="statWorkflows">--</div>
                    <div class="login-stat-label">Workflows n8n</div>
                </div>
                <div class="login-stat">
                    <div class="login-stat-value">‚àû</div>
                    <div class="login-stat-label">Possibilit√©s</div>
                </div>
            </div>
        </div>
        
        <div class="login-right">
            <div class="login-card">
                <h2>Bienvenue</h2>
                <p>Connectez-vous pour acc√©der √† votre centre de pilotage</p>
                
                <div class="login-divider"><span>Choisir un profil</span></div>
                
                <div class="demo-accounts">
                    <div class="demo-account" onclick="login('admin')">
                        <div class="demo-account-avatar admin">L</div>
                        <div class="demo-account-info">
                            <strong>Lloyd Martin</strong>
                            <span>Administrateur ‚Ä¢ Work Formation</span>
                        </div>
                        <div class="demo-account-arrow">‚Üí</div>
                    </div>
                    
                    <div class="demo-account" onclick="login('client')">
                        <div class="demo-account-avatar client">M</div>
                        <div class="demo-account-info">
                            <strong>Marie Dupont</strong>
                            <span>Client ‚Ä¢ Entreprise SAS</span>
                        </div>
                        <div class="demo-account-arrow">‚Üí</div>
                    </div>
                </div>
                
                <div class="login-footer">
                    <p>Probl√®me de connexion ? <a href="#">Contactez le support</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div class="app-container" id="appContainer">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar"></aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header" id="header"></header>
            <div class="page-content" id="pageContent"></div>
        </main>
    </div>

<script>
// ============================================
// SABRINA COMMAND CENTER V1.0
// Configuration & API Layer
// ============================================

// CONFIGURATION N8N
const N8N_CONFIG = {
    baseUrl: 'https://n8n.srv1121126.hstgr.cloud',
    apiKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJkMWJiNTBjYy1mZTk3LTQ1ZjYtYmNlYy1iZThiMmRmZDgzZjkiLCJpc3MiOiJuOG4iLCJhdWQiOiJwdWJsaWMtYXBpIiwiaWF0IjoxNzYzOTk0NDkzfQ.Lm7U5QhR9AhGbYCZSqnOYZEh1SXv4FsF0qK5HX9Eymg',
    webhookBase: 'https://n8n.srv1121126.hstgr.cloud/webhook',
    timeout: 60000
};

// GOOGLE SHEETS CONFIG
const SHEETS_CONFIG = {
    memoryId: '1_uTVmR92FNHbjbaTx5uKPxRiaU_dOnJdGpw8aWnxOQY'
};

// MODULES CONNUS (sera mis √† jour dynamiquement via API)
let SABRINA_MODULES = [
    { id: 'core', name: 'SABRINA Core', icon: 'üß†', path: 'Sabrina', description: 'Assistant g√©n√©ral polyvalent', category: 'general', active: true },
    { id: 'marketing', name: 'SABRINA Marketing', icon: 'üì¢', path: 'sabrina-marketing', description: 'Strat√©gie marketing et contenu', category: 'business', active: true },
    { id: 'commercial', name: 'SABRINA Commercial', icon: 'üíº', path: 'sabrina-commercial', description: 'Prospection et vente', category: 'business', active: true },
    { id: 'ceo', name: 'SABRINA CEO', icon: 'üëî', path: 'sabrina-ceo', description: 'Pilotage strat√©gique', category: 'direction', active: true },
    { id: 'rh', name: 'SABRINA RH', icon: 'üë•', path: 'sabrina-rh', description: 'Ressources humaines', category: 'metier', active: true },
    { id: 'formations', name: 'SABRINA Formations', icon: 'üìö', path: 'sabrina-formations-web', description: 'Expert Qualiopi et p√©dagogie', category: 'metier', active: true },
    { id: 'audit', name: 'SABRINA Audit', icon: 'üîç', path: 'sabrina-audit', description: 'Diagnostic entreprise', category: 'tools', active: true },
    { id: 'creator', name: 'SABRINA Creator', icon: '‚öôÔ∏è', path: 'sabrina-creator-v2', description: 'Cr√©ation de modules IA', category: 'tools', active: true },
    { id: 'webbuilder', name: 'SABRINA Web Builder', icon: 'üåê', path: 'sabrina-web-builder', description: 'G√©n√©ration d\'interfaces web', category: 'tools', active: true },
    { id: 'comptabilite', name: 'SABRINA Comptabilit√©', icon: 'üí∞', path: 'sabrina-comptabilite', description: 'Gestion financi√®re', category: 'business', active: true }
];

// UTILISATEURS
const USERS = {
    admin: {
        id: 'admin-1',
        name: 'Lloyd Martin',
        email: 'lloyd@workformation.fr',
        role: 'admin',
        company: 'Work Formation',
        avatar: 'L',
        modulesAccess: 'all'
    },
    client: {
        id: 'client-1',
        name: 'Marie Dupont',
        email: 'marie@entreprise.fr',
        role: 'client',
        company: 'Entreprise SAS',
        avatar: 'M',
        subscription: 'Premium',
        modulesAccess: ['core', 'formations', 'marketing', 'rh']
    }
};

// √âTAT GLOBAL DE L'APPLICATION
const APP = {
    state: {
        currentUser: null,
        currentPage: 'cockpit',
        selectedModule: 'core',
        isTyping: false,
        chatHistory: [],
        workflows: [],
        clients: [],
        audits: [],
        devis: [],
        factures: [],
        n8nConnected: false,
        lastSync: null
    },
    
    // Cache pour les donn√©es
    cache: {
        workflows: null,
        workflowsTimestamp: null
    }
};

// ============================================
// N8N API LAYER
// ============================================

const N8N_API = {
    // Headers communs pour l'API
    getHeaders() {
        return {
            'X-N8N-API-KEY': N8N_CONFIG.apiKey,
            'Content-Type': 'application/json'
        };
    },

    // R√©cup√©rer tous les workflows
    async getWorkflows() {
        try {
            const response = await fetch(`${N8N_CONFIG.baseUrl}/api/v1/workflows`, {
                method: 'GET',
                headers: this.getHeaders()
            });
            
            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }
            
            const data = await response.json();
            APP.state.workflows = data.data || [];
            APP.state.n8nConnected = true;
            APP.state.lastSync = new Date();
            
            // Mettre √† jour les modules avec les donn√©es r√©elles
            this.syncModulesWithWorkflows(APP.state.workflows);
            
            return APP.state.workflows;
        } catch (error) {
            console.error('‚ùå Erreur API n8n:', error);
            APP.state.n8nConnected = false;
            throw error;
        }
    },

    // R√©cup√©rer un workflow sp√©cifique
    async getWorkflow(id) {
        try {
            const response = await fetch(`${N8N_CONFIG.baseUrl}/api/v1/workflows/${id}`, {
                method: 'GET',
                headers: this.getHeaders()
            });
            
            if (!response.ok) throw new Error(`API Error: ${response.status}`);
            return await response.json();
        } catch (error) {
            console.error('‚ùå Erreur r√©cup√©ration workflow:', error);
            throw error;
        }
    },

    // Activer un workflow
    async activateWorkflow(id) {
        try {
            const response = await fetch(`${N8N_CONFIG.baseUrl}/api/v1/workflows/${id}/activate`, {
                method: 'POST',
                headers: this.getHeaders()
            });
            
            if (!response.ok) throw new Error(`API Error: ${response.status}`);
            
            showToast('success', 'Workflow activ√©', 'Le workflow est maintenant actif');
            await this.getWorkflows(); // Refresh
            return await response.json();
        } catch (error) {
            console.error('‚ùå Erreur activation workflow:', error);
            showToast('error', 'Erreur', 'Impossible d\'activer le workflow');
            throw error;
        }
    },

    // D√©sactiver un workflow
    async deactivateWorkflow(id) {
        try {
            const response = await fetch(`${N8N_CONFIG.baseUrl}/api/v1/workflows/${id}/deactivate`, {
                method: 'POST',
                headers: this.getHeaders()
            });
            
            if (!response.ok) throw new Error(`API Error: ${response.status}`);
            
            showToast('success', 'Workflow d√©sactiv√©', 'Le workflow est maintenant inactif');
            await this.getWorkflows(); // Refresh
            return await response.json();
        } catch (error) {
            console.error('‚ùå Erreur d√©sactivation workflow:', error);
            showToast('error', 'Erreur', 'Impossible de d√©sactiver le workflow');
            throw error;
        }
    },

    // Ex√©cuter un workflow manuellement
    async executeWorkflow(id, data = {}) {
        try {
            const response = await fetch(`${N8N_CONFIG.baseUrl}/api/v1/workflows/${id}/run`, {
                method: 'POST',
                headers: this.getHeaders(),
                body: JSON.stringify(data)
            });
            
            if (!response.ok) throw new Error(`API Error: ${response.status}`);
            return await response.json();
        } catch (error) {
            console.error('‚ùå Erreur ex√©cution workflow:', error);
            throw error;
        }
    },

    // Synchroniser les modules avec les workflows n8n
    syncModulesWithWorkflows(workflows) {
        // Mapper les workflows n8n aux modules SABRINA
        workflows.forEach(wf => {
            const moduleName = wf.name.toLowerCase();
            
            // Chercher si c'est un module SABRINA
            const existingModule = SABRINA_MODULES.find(m => 
                moduleName.includes(m.id) || 
                moduleName.includes(m.name.toLowerCase().replace('sabrina ', ''))
            );
            
            if (existingModule) {
                existingModule.workflowId = wf.id;
                existingModule.active = wf.active;
                existingModule.workflowName = wf.name;
            } else if (moduleName.includes('sabrina')) {
                // Nouveau module d√©tect√© !
                const newModule = {
                    id: wf.name.toLowerCase().replace(/\s+/g, '-'),
                    name: wf.name,
                    icon: 'üÜï',
                    path: wf.name.toLowerCase().replace(/\s+/g, '-'),
                    description: 'Module d√©tect√© automatiquement',
                    category: 'detected',
                    active: wf.active,
                    workflowId: wf.id,
                    workflowName: wf.name,
                    isNew: true
                };
                
                // V√©rifier qu'il n'existe pas d√©j√†
                if (!SABRINA_MODULES.find(m => m.workflowId === wf.id)) {
                    SABRINA_MODULES.push(newModule);
                    console.log('üÜï Nouveau module d√©tect√©:', newModule.name);
                }
            }
        });
        
        // Mettre √† jour les stats
        updateStats();
    }
};

// ============================================
// SABRINA CHAT API
// ============================================

const SABRINA_API = {
    // Envoyer un message √† un module SABRINA
    async sendMessage(message, moduleId = 'core') {
        const module = SABRINA_MODULES.find(m => m.id === moduleId);
        if (!module) {
            throw new Error('Module non trouv√©');
        }

        const webhookUrl = `${N8N_CONFIG.webhookBase}/${module.path}`;
        
        console.log(`üì° Envoi √† ${module.name}:`, message);
        
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), N8N_CONFIG.timeout);

            const response = await fetch(webhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userMessage: message,
                    userId: APP.state.currentUser?.id || 'anonymous',
                    module: moduleId,
                    timestamp: new Date().toISOString()
                }),
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status}`);
            }

            const data = await response.text();
            console.log(`‚úÖ R√©ponse de ${module.name} re√ßue`);
            
            APP.state.n8nConnected = true;
            return data;
        } catch (error) {
            console.error('‚ùå Erreur SABRINA API:', error);
            
            if (error.name === 'AbortError') {
                throw new Error('Timeout - Le serveur met trop de temps √† r√©pondre');
            }
            
            APP.state.n8nConnected = false;
            throw error;
        }
    },

    // Tester la connexion √† un module
    async testModule(moduleId) {
        try {
            const response = await this.sendMessage('Test de connexion', moduleId);
            return { success: true, response };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }
};

// ============================================
// UTILITY FUNCTIONS
// ============================================

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatMarkdown(text) {
    if (!text) return '';
    
    return text
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/`(.+?)`/g, '<code style="background:var(--bg-main);padding:2px 6px;border-radius:4px;font-family:\'JetBrains Mono\',monospace;font-size:0.85em">$1</code>')
        .replace(/### (.+)/g, '<h4 style="margin:16px 0 8px;font-size:1rem;font-weight:600">$1</h4>')
        .replace(/## (.+)/g, '<h3 style="margin:20px 0 10px;font-size:1.1rem;font-weight:600">$1</h3>')
        .replace(/# (.+)/g, '<h2 style="margin:24px 0 12px;font-size:1.25rem;font-weight:700">$1</h2>')
        .replace(/\n- /g, '<br>‚Ä¢ ')
        .replace(/\n\d+\. /g, (match) => '<br>' + match.trim() + ' ')
        .replace(/\n/g, '<br>');
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('fr-FR', { 
        style: 'currency', 
        currency: 'EUR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return new Intl.DateTimeFormat('fr-FR', {
        day: 'numeric',
        month: 'short',
        year: 'numeric'
    }).format(date);
}

function formatDateTime(dateStr) {
    const date = new Date(dateStr);
    return new Intl.DateTimeFormat('fr-FR', {
        day: 'numeric',
        month: 'short',
        hour: '2-digit',
        minute: '2-digit'
    }).format(date);
}

function formatTimeAgo(date) {
    const now = new Date();
    const diff = now - new Date(date);
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    
    if (minutes < 1) return '√Ä l\'instant';
    if (minutes < 60) return `Il y a ${minutes}min`;
    if (hours < 24) return `Il y a ${hours}h`;
    if (days < 7) return `Il y a ${days}j`;
    return formatDate(date);
}

function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

// ============================================
// TOAST NOTIFICATIONS
// ============================================

function showToast(type, title, message, duration = 5000) {
    const container = document.getElementById('toastContainer');
    const icons = {
        success: '‚úì',
        error: '‚úï',
        warning: '‚ö†',
        info: '‚Ñπ'
    };
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <div class="toast-icon">${icons[type] || '‚Ñπ'}</div>
        <div class="toast-content">
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
    `;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideInRight 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

// ============================================
// MODAL
// ============================================

function openModal(title, content, footer = '') {
    const overlay = document.getElementById('modalOverlay');
    const modal = document.getElementById('modalContent');
    
    modal.innerHTML = `
        <div class="modal-header">
            <h3 class="modal-title">${title}</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">${content}</div>
        ${footer ? `<div class="modal-footer">${footer}</div>` : ''}
    `;
    
    overlay.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    const overlay = document.getElementById('modalOverlay');
    overlay.classList.remove('active');
    document.body.style.overflow = '';
}

// Fermer modal en cliquant √† l'ext√©rieur
document.getElementById('modalOverlay').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) {
        closeModal();
    }
});

// ============================================
// UPDATE STATS
// ============================================

function updateStats() {
    const activeModules = SABRINA_MODULES.filter(m => m.active).length;
    const totalWorkflows = APP.state.workflows.length;
    
    const statModules = document.getElementById('statModules');
    const statWorkflows = document.getElementById('statWorkflows');
    
    if (statModules) statModules.textContent = activeModules;
    if (statWorkflows) statWorkflows.textContent = totalWorkflows;
}

// ============================================
// INITIALISATION AU CHARGEMENT
// ============================================

document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ SABRINA Command Center V1.0 - Initialisation...');
    
    // Tenter de r√©cup√©rer les workflows n8n
    try {
        await N8N_API.getWorkflows();
        console.log('‚úÖ Connect√© √† n8n -', APP.state.workflows.length, 'workflows d√©tect√©s');
    } catch (error) {
        console.warn('‚ö†Ô∏è Impossible de se connecter √† n8n:', error.message);
    }
    
    updateStats();
});

// ============================================
// LOGIN SYSTEM
// ============================================

function login(userType) {
    const user = USERS[userType];
    if (!user) {
        showToast('error', 'Erreur', 'Utilisateur non trouv√©');
        return;
    }
    
    APP.state.currentUser = user;
    
    // Masquer login, afficher app
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appContainer').classList.add('active');
    
    // Initialiser l'interface
    initializeApp();
    
    showToast('success', `Bienvenue ${user.name}`, `Connect√© en tant que ${user.role === 'admin' ? 'Administrateur' : 'Client'}`);
}

function logout() {
    APP.state.currentUser = null;
    APP.state.currentPage = 'cockpit';
    APP.state.chatHistory = [];
    
    document.getElementById('appContainer').classList.remove('active');
    document.getElementById('loginScreen').style.display = 'flex';
    
    showToast('info', 'D√©connexion', '√Ä bient√¥t !');
}

function initializeApp() {
    renderSidebar();
    renderHeader();
    navigateTo(APP.state.currentPage);
    
    // D√©marrer le polling de synchronisation n8n
    startN8NSync();
}

// ============================================
// N8N SYNC POLLING
// ============================================

let syncInterval = null;

function startN8NSync() {
    // Sync imm√©diat
    syncN8N();
    
    // Puis toutes les 30 secondes
    syncInterval = setInterval(syncN8N, 30000);
}

async function syncN8N() {
    try {
        await N8N_API.getWorkflows();
        updateConnectionStatus(true);
    } catch (error) {
        updateConnectionStatus(false);
    }
}

function updateConnectionStatus(connected) {
    const statusEl = document.getElementById('connectionStatus');
    if (statusEl) {
        if (connected) {
            statusEl.className = 'connection-status';
            statusEl.innerHTML = '<span class="connection-dot"></span> Connect√© √† n8n';
        } else {
            statusEl.className = 'connection-status disconnected';
            statusEl.innerHTML = '<span class="connection-dot"></span> D√©connect√©';
        }
    }
}

// ============================================
// SIDEBAR RENDER
// ============================================

function renderSidebar() {
    const sidebar = document.getElementById('sidebar');
    const user = APP.state.currentUser;
    const isAdmin = user.role === 'admin';
    
    const adminNav = `
        <div class="nav-section">
            <div class="nav-section-title">Principal</div>
            <div class="nav-item ${APP.state.currentPage === 'cockpit' ? 'active' : ''}" onclick="navigateTo('cockpit')">
                <span class="nav-item-icon">üìä</span>
                <span class="nav-item-text">Cockpit</span>
            </div>
            <div class="nav-item ${APP.state.currentPage === 'chat' ? 'active' : ''}" onclick="navigateTo('chat')">
                <span class="nav-item-icon">üí¨</span>
                <span class="nav-item-text">Chat SABRINA</span>
            </div>
        </div>
        
        <div class="nav-section">
            <div class="nav-section-title">Business</div>
            <div class="nav-item ${APP.state.currentPage === 'clients' ? 'active' : ''}" onclick="navigateTo('clients')">
                <span class="nav-item-icon">üë•</span>
                <span class="nav-item-text">Clients</span>
                <span class="nav-item-badge">${APP.state.clients.length || 0}</span>
            </div>
            <div class="nav-item ${APP.state.currentPage === 'pipeline' ? 'active' : ''}" onclick="navigateTo('pipeline')">
                <span class="nav-item-icon">üìà</span>
                <span class="nav-item-text">Pipeline</span>
            </div>
            <div class="nav-item ${APP.state.currentPage === 'audits' ? 'active' : ''}" onclick="navigateTo('audits')">
                <span class="nav-item-icon">üîç</span>
                <span class="nav-item-text">Audits</span>
            </div>
            <div class="nav-item ${APP.state.currentPage === 'devis' ? 'active' : ''}" onclick="navigateTo('devis')">
                <span class="nav-item-icon">üìù</span>
                <span class="nav-item-text">Devis</span>
            </div>
            <div class="nav-item ${APP.state.currentPage === 'factures' ? 'active' : ''}" onclick="navigateTo('factures')">
                <span class="nav-item-icon">üí≥</span>
                <span class="nav-item-text">Factures</span>
            </div>
        </div>
        
        <div class="nav-section">
            <div class="nav-section-title">Syst√®me</div>
            <div class="nav-item ${APP.state.currentPage === 'modules' ? 'active' : ''}" onclick="navigateTo('modules')">
                <span class="nav-item-icon">üß©</span>
                <span class="nav-item-text">Modules IA</span>
            </div>
            <div class="nav-item ${APP.state.currentPage === 'workflows' ? 'active' : ''}" onclick="navigateTo('workflows')">
                <span class="nav-item-icon">‚öôÔ∏è</span>
                <span class="nav-item-text">Workflows n8n</span>
            </div>
            <div class="nav-item ${APP.state.currentPage === 'settings' ? 'active' : ''}" onclick="navigateTo('settings')">
                <span class="nav-item-icon">‚ö°</span>
                <span class="nav-item-text">Param√®tres</span>
            </div>
        </div>
    `;
    
    const clientNav = `
        <div class="nav-section">
            <div class="nav-section-title">Mon espace</div>
            <div class="nav-item ${APP.state.currentPage === 'dashboard' ? 'active' : ''}" onclick="navigateTo('dashboard')">
                <span class="nav-item-icon">üè†</span>
                <span class="nav-item-text">Dashboard</span>
            </div>
            <div class="nav-item ${APP.state.currentPage === 'chat' ? 'active' : ''}" onclick="navigateTo('chat')">
                <span class="nav-item-icon">üí¨</span>
                <span class="nav-item-text">Chat SABRINA</span>
            </div>
            <div class="nav-item ${APP.state.currentPage === 'documents' ? 'active' : ''}" onclick="navigateTo('documents')">
                <span class="nav-item-icon">üìÅ</span>
                <span class="nav-item-text">Mes documents</span>
            </div>
            <div class="nav-item ${APP.state.currentPage === 'historique' ? 'active' : ''}" onclick="navigateTo('historique')">
                <span class="nav-item-icon">üìú</span>
                <span class="nav-item-text">Historique</span>
            </div>
        </div>
        
        <div class="nav-section">
            <div class="nav-section-title">Compte</div>
            <div class="nav-item ${APP.state.currentPage === 'subscription' ? 'active' : ''}" onclick="navigateTo('subscription')">
                <span class="nav-item-icon">‚≠ê</span>
                <span class="nav-item-text">Abonnement</span>
            </div>
            <div class="nav-item ${APP.state.currentPage === 'support' ? 'active' : ''}" onclick="navigateTo('support')">
                <span class="nav-item-icon">üéß</span>
                <span class="nav-item-text">Support</span>
            </div>
        </div>
    `;
    
    sidebar.innerHTML = `
        <div class="sidebar-header">
            <div class="sidebar-brand">
                <div class="sidebar-brand-logo">S</div>
                <div class="sidebar-brand-text">SABRINA<span>.</span></div>
            </div>
            <div class="sidebar-subtitle">Command Center</div>
        </div>
        
        <nav class="sidebar-nav">
            ${isAdmin ? adminNav : clientNav}
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-menu" onclick="toggleUserMenu()">
                <div class="user-avatar">${user.avatar}</div>
                <div class="user-info">
                    <div class="user-name">${user.name}</div>
                    <div class="user-role">${isAdmin ? 'Administrateur' : user.subscription}</div>
                </div>
                <div class="user-menu-icon">‚ãÆ</div>
            </div>
        </div>
    `;
}

function toggleUserMenu() {
    openModal('Mon compte', `
        <div style="text-align: center; padding: 20px 0;">
            <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--gold-gradient); display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 700; color: var(--bg-deep); margin: 0 auto 16px;">
                ${APP.state.currentUser.avatar}
            </div>
            <h3 style="font-size: 1.25rem; margin-bottom: 4px;">${APP.state.currentUser.name}</h3>
            <p style="color: var(--text-secondary);">${APP.state.currentUser.email}</p>
            <p style="color: var(--text-muted); font-size: 0.875rem;">${APP.state.currentUser.company}</p>
        </div>
        
        <div style="border-top: 1px solid var(--border-light); padding-top: 20px; margin-top: 20px;">
            <button class="btn btn-secondary btn-block" style="margin-bottom: 12px;" onclick="navigateTo('settings'); closeModal();">
                ‚ö° Param√®tres
            </button>
            <button class="btn btn-danger btn-block" onclick="logout(); closeModal();">
                üö™ D√©connexion
            </button>
        </div>
    `);
}

// ============================================
// HEADER RENDER
// ============================================

function renderHeader() {
    const header = document.getElementById('header');
    const pageTitles = {
        cockpit: 'Cockpit',
        chat: 'Chat SABRINA',
        clients: 'Gestion Clients',
        pipeline: 'Pipeline Commercial',
        audits: 'Centre d\'Audits',
        devis: 'Gestion Devis',
        factures: 'Facturation',
        modules: 'Modules IA',
        workflows: 'Workflows n8n',
        settings: 'Param√®tres',
        dashboard: 'Mon Dashboard',
        documents: 'Mes Documents',
        historique: 'Historique',
        subscription: 'Mon Abonnement',
        support: 'Support'
    };
    
    header.innerHTML = `
        <div class="header-left">
            <div>
                <div class="header-title">${pageTitles[APP.state.currentPage] || 'SABRINA'}</div>
                <div class="header-subtitle">${formatDateTime(new Date())}</div>
            </div>
        </div>
        
        <div class="header-actions">
            <div class="header-search">
                <span class="header-search-icon">üîç</span>
                <input type="text" placeholder="Rechercher..." id="globalSearch" onkeyup="handleGlobalSearch(event)">
            </div>
            
            <div class="connection-status ${APP.state.n8nConnected ? '' : 'disconnected'}" id="connectionStatus">
                <span class="connection-dot"></span>
                ${APP.state.n8nConnected ? 'Connect√© √† n8n' : 'D√©connect√©'}
            </div>
            
            <button class="header-icon-btn" onclick="refreshData()" title="Rafra√Æchir">
                üîÑ
            </button>
            
            <button class="header-icon-btn" onclick="showNotifications()" title="Notifications">
                üîî
                <span class="badge">3</span>
            </button>
        </div>
    `;
}

function handleGlobalSearch(event) {
    if (event.key === 'Enter') {
        const query = event.target.value.trim();
        if (query) {
            showToast('info', 'Recherche', `Recherche de "${query}"...`);
            // TODO: Impl√©menter la recherche globale
        }
    }
}

async function refreshData() {
    showToast('info', 'Synchronisation', 'Mise √† jour des donn√©es...');
    try {
        await N8N_API.getWorkflows();
        renderPage(APP.state.currentPage);
        showToast('success', 'Synchronis√©', 'Donn√©es mises √† jour');
    } catch (error) {
        showToast('error', 'Erreur', 'Impossible de synchroniser');
    }
}

function showNotifications() {
    openModal('Notifications', `
        <div style="display: flex; flex-direction: column; gap: 12px;">
            <div style="padding: 16px; background: var(--success-bg); border-radius: var(--radius-md); border-left: 4px solid var(--success);">
                <div style="font-weight: 600; margin-bottom: 4px;">‚úì Connexion n8n √©tablie</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);">Tous les workflows sont synchronis√©s</div>
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px;">Il y a 2 minutes</div>
            </div>
            
            <div style="padding: 16px; background: var(--warning-bg); border-radius: var(--radius-md); border-left: 4px solid var(--warning);">
                <div style="font-weight: 600; margin-bottom: 4px;">‚ö† Nouvel audit en attente</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);">Entreprise XYZ a compl√©t√© l'audit</div>
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px;">Il y a 1 heure</div>
            </div>
            
            <div style="padding: 16px; background: var(--info-bg); border-radius: var(--radius-md); border-left: 4px solid var(--info);">
                <div style="font-weight: 600; margin-bottom: 4px;">‚Ñπ Nouveau module d√©tect√©</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);">SABRINA Comptabilit√© est disponible</div>
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px;">Hier</div>
            </div>
        </div>
    `);
}

// ============================================
// NAVIGATION
// ============================================

function navigateTo(page) {
    APP.state.currentPage = page;
    renderSidebar();
    renderHeader();
    renderPage(page);
    
    // Scroll to top
    window.scrollTo(0, 0);
}

function renderPage(page) {
    const content = document.getElementById('pageContent');
    
    const pages = {
        cockpit: renderCockpitPage,
        chat: renderChatPage,
        clients: renderClientsPage,
        pipeline: renderPipelinePage,
        audits: renderAuditsPage,
        devis: renderDevisPage,
        factures: renderFacturesPage,
        modules: renderModulesPage,
        workflows: renderWorkflowsPage,
        settings: renderSettingsPage,
        dashboard: renderClientDashboard,
        documents: renderDocumentsPage,
        historique: renderHistoriquePage,
        subscription: renderSubscriptionPage,
        support: renderSupportPage
    };
    
    const renderFn = pages[page];
    if (renderFn) {
        content.innerHTML = '<div class="animate-fade">' + renderFn() + '</div>';
        
        // Post-render initialization
        if (page === 'chat') {
            initChatPage();
        }
    } else {
        content.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üöß</div>
                <h3>Page en construction</h3>
                <p>Cette fonctionnalit√© sera bient√¥t disponible.</p>
            </div>
        `;
    }
}

// ============================================
// PAGE: COCKPIT (Admin Dashboard)
// ============================================

function renderCockpitPage() {
    const activeModules = SABRINA_MODULES.filter(m => m.active).length;
    const totalWorkflows = APP.state.workflows.length;
    
    return `
        <div class="page-header">
            <div class="page-header-left">
                <h1>Bienvenue, ${APP.state.currentUser.name.split(' ')[0]} üëã</h1>
                <p>Voici l'√©tat de votre business aujourd'hui</p>
            </div>
            <div class="page-header-actions">
                <button class="btn btn-secondary" onclick="navigateTo('audits')">
                    üîç Nouvel Audit
                </button>
                <button class="btn btn-primary" onclick="navigateTo('chat')">
                    üí¨ Parler √† SABRINA
                </button>
            </div>
        </div>
        
        <!-- KPIs -->
        <div class="grid-4" style="margin-bottom: 32px;">
            <div class="stat-card animate-slide-up stagger-1">
                <div class="stat-card-header">
                    <div class="stat-card-icon gold">üí∞</div>
                    <div class="stat-card-trend up">‚Üë 12%</div>
                </div>
                <div class="stat-card-value">4 850 ‚Ç¨</div>
                <div class="stat-card-label">MRR (Revenus mensuels)</div>
            </div>
            
            <div class="stat-card animate-slide-up stagger-2">
                <div class="stat-card-header">
                    <div class="stat-card-icon blue">üë•</div>
                    <div class="stat-card-trend up">‚Üë 2</div>
                </div>
                <div class="stat-card-value">12</div>
                <div class="stat-card-label">Clients actifs</div>
            </div>
            
            <div class="stat-card animate-slide-up stagger-3">
                <div class="stat-card-header">
                    <div class="stat-card-icon green">üìà</div>
                </div>
                <div class="stat-card-value">8 200 ‚Ç¨</div>
                <div class="stat-card-label">Pipeline en cours</div>
            </div>
            
            <div class="stat-card animate-slide-up stagger-4">
                <div class="stat-card-header">
                    <div class="stat-card-icon red">üéØ</div>
                </div>
                <div class="stat-card-value">67%</div>
                <div class="stat-card-label">Taux de conversion</div>
            </div>
        </div>
        
        <!-- Contenu principal -->
        <div class="grid-3">
            <!-- Activit√© r√©cente -->
            <div class="card animate-slide-up" style="grid-column: span 2;">
                <div class="card-header">
                    <div>
                        <div class="card-title">Activit√© r√©cente</div>
                        <div class="card-subtitle">Les derni√®res actions sur votre plateforme</div>
                    </div>
                    <button class="btn btn-ghost btn-sm">Voir tout ‚Üí</button>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div style="display: flex; flex-direction: column;">
                        ${renderActivityItem('üîç', 'Audit compl√©t√©', 'Entreprise ABC - Score: 72%', '10 min', 'success')}
                        ${renderActivityItem('üí¨', 'Conversation', 'Marie D. a discut√© avec SABRINA Marketing', '25 min', 'info')}
                        ${renderActivityItem('üìù', 'Devis envoy√©', 'Pack Premium - 2 400 ‚Ç¨ ‚Üí Client XYZ', '1h', 'warning')}
                        ${renderActivityItem('‚úì', 'Facture pay√©e', 'Facture #2024-042 - 490 ‚Ç¨', '2h', 'success')}
                        ${renderActivityItem('üÜï', 'Nouveau module', 'SABRINA Comptabilit√© activ√©', '5h', 'info')}
                    </div>
                </div>
            </div>
            
            <!-- Modules IA -->
            <div class="card animate-slide-up">
                <div class="card-header">
                    <div>
                        <div class="card-title">Modules IA</div>
                        <div class="card-subtitle">${activeModules} actifs sur ${SABRINA_MODULES.length}</div>
                    </div>
                </div>
                <div class="card-body" style="padding: 12px;">
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        ${SABRINA_MODULES.slice(0, 6).map(m => `
                            <div style="display: flex; align-items: center; gap: 12px; padding: 10px 12px; background: var(--bg-main); border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-fast);" 
                                 onmouseover="this.style.background='var(--bg-hover)'" 
                                 onmouseout="this.style.background='var(--bg-main)'"
                                 onclick="APP.state.selectedModule='${m.id}'; navigateTo('chat')">
                                <span style="font-size: 1.25rem;">${m.icon}</span>
                                <span style="flex: 1; font-weight: 500; font-size: 0.9rem;">${m.name.replace('SABRINA ', '')}</span>
                                <span class="badge ${m.active ? 'badge-success' : 'badge-neutral'}">${m.active ? 'Actif' : 'Inactif'}</span>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn-ghost btn-block" style="margin-top: 12px;" onclick="navigateTo('modules')">
                        Voir tous les modules ‚Üí
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Workflows n8n -->
        <div class="card animate-slide-up" style="margin-top: 24px;">
            <div class="card-header">
                <div>
                    <div class="card-title">Workflows n8n</div>
                    <div class="card-subtitle">${totalWorkflows} workflows - Derni√®re sync: ${APP.state.lastSync ? formatTimeAgo(APP.state.lastSync) : 'Jamais'}</div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-ghost btn-sm" onclick="refreshData()">üîÑ Sync</button>
                    <button class="btn btn-secondary btn-sm" onclick="navigateTo('workflows')">G√©rer ‚Üí</button>
                </div>
            </div>
            <div class="card-body" style="padding: 0;">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Workflow</th>
                                <th>Statut</th>
                                <th>ID</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${APP.state.workflows.length > 0 ? APP.state.workflows.slice(0, 5).map(wf => `
                                <tr>
                                    <td style="font-weight: 500;">${wf.name}</td>
                                    <td>
                                        <span class="badge ${wf.active ? 'badge-success' : 'badge-neutral'}">
                                            ${wf.active ? '‚óè Actif' : '‚óã Inactif'}
                                        </span>
                                    </td>
                                    <td style="font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--text-muted);">${wf.id}</td>
                                    <td>
                                        <button class="btn btn-ghost btn-sm" onclick="toggleWorkflow('${wf.id}', ${wf.active})">
                                            ${wf.active ? '‚è∏ D√©sactiver' : '‚ñ∂ Activer'}
                                        </button>
                                    </td>
                                </tr>
                            `).join('') : `
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                        ${APP.state.n8nConnected ? 'Aucun workflow trouv√©' : 'Connexion √† n8n en cours...'}
                                    </td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

function renderActivityItem(icon, title, description, time, type) {
    const colors = {
        success: 'var(--success)',
        warning: 'var(--warning)',
        info: 'var(--info)',
        danger: 'var(--danger)'
    };
    
    return `
        <div style="display: flex; align-items: flex-start; gap: 16px; padding: 16px 24px; border-bottom: 1px solid var(--border-light); transition: background var(--transition-fast);"
             onmouseover="this.style.background='var(--bg-hover)'" 
             onmouseout="this.style.background='transparent'">
            <div style="width: 40px; height: 40px; border-radius: 50%; background: ${colors[type]}20; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0;">
                ${icon}
            </div>
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 600; font-size: 0.9375rem; margin-bottom: 2px;">${title}</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);">${description}</div>
            </div>
            <div style="font-size: 0.8125rem; color: var(--text-muted); white-space: nowrap;">
                ${time}
            </div>
        </div>
    `;
}

async function toggleWorkflow(id, isCurrentlyActive) {
    try {
        if (isCurrentlyActive) {
            await N8N_API.deactivateWorkflow(id);
        } else {
            await N8N_API.activateWorkflow(id);
        }
        renderPage(APP.state.currentPage);
    } catch (error) {
        // Error already shown by API
    }
}

// ============================================
// PAGE: CHAT SABRINA
// ============================================

function renderChatPage() {
    const user = APP.state.currentUser;
    const isAdmin = user.role === 'admin';
    
    // Modules accessibles
    const accessibleModules = isAdmin 
        ? SABRINA_MODULES 
        : SABRINA_MODULES.filter(m => user.modulesAccess.includes(m.id));
    
    const selectedModule = SABRINA_MODULES.find(m => m.id === APP.state.selectedModule) || SABRINA_MODULES[0];
    
    return `
        <div style="display: flex; height: calc(100vh - var(--header-height) - 64px); gap: 24px;">
            <!-- Sidebar Modules -->
            <div style="width: 280px; flex-shrink: 0; display: flex; flex-direction: column;">
                <div class="card" style="flex: 1; display: flex; flex-direction: column;">
                    <div class="card-header">
                        <div class="card-title">Modules IA</div>
                    </div>
                    <div style="flex: 1; overflow-y: auto; padding: 12px;">
                        ${accessibleModules.map(m => `
                            <div class="module-item ${m.id === APP.state.selectedModule ? 'active' : ''}" 
                                 onclick="selectModule('${m.id}')"
                                 style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; border-radius: var(--radius-md); cursor: pointer; margin-bottom: 8px; transition: all var(--transition-fast); background: ${m.id === APP.state.selectedModule ? 'var(--gold-light)' : 'var(--bg-main)'}; border: 2px solid ${m.id === APP.state.selectedModule ? 'var(--gold)' : 'transparent'};">
                                <span style="font-size: 1.5rem;">${m.icon}</span>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 600; font-size: 0.9375rem; color: ${m.id === APP.state.selectedModule ? 'var(--gold-dark)' : 'var(--text-primary)'};">
                                        ${m.name.replace('SABRINA ', '')}
                                    </div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        ${m.description}
                                    </div>
                                </div>
                                ${m.active ? '<span class="badge badge-success" style="font-size: 0.65rem;">ON</span>' : '<span class="badge badge-neutral" style="font-size: 0.65rem;">OFF</span>'}
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
            
            <!-- Zone de Chat -->
            <div class="card" style="flex: 1; display: flex; flex-direction: column;">
                <!-- Header Chat -->
                <div class="card-header" style="border-bottom: 1px solid var(--border-light);">
                    <div style="display: flex; align-items: center; gap: 14px;">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: var(--gold-gradient); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                            ${selectedModule.icon}
                        </div>
                        <div>
                            <div class="card-title">${selectedModule.name}</div>
                            <div class="card-subtitle" style="display: flex; align-items: center; gap: 8px;">
                                <span style="width: 8px; height: 8px; border-radius: 50%; background: ${selectedModule.active ? 'var(--success)' : 'var(--text-muted)'}; animation: ${selectedModule.active ? 'pulse 2s infinite' : 'none'};"></span>
                                ${selectedModule.active ? 'En ligne' : 'Hors ligne'}
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-ghost btn-sm" onclick="clearChat()">üóë Effacer</button>
                        <button class="btn btn-ghost btn-sm" onclick="testModule('${selectedModule.id}')">üîå Tester</button>
                    </div>
                </div>
                
                <!-- Messages -->
                <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 16px;">
                    <!-- Messages seront ajout√©s ici -->
                    <div style="text-align: center; padding: 40px 0;">
                        <div style="font-size: 3rem; margin-bottom: 16px;">${selectedModule.icon}</div>
                        <h3 style="font-size: 1.125rem; margin-bottom: 8px;">Bienvenue sur ${selectedModule.name}</h3>
                        <p style="color: var(--text-secondary); max-width: 400px; margin: 0 auto;">
                            ${selectedModule.description}. Posez votre question ci-dessous.
                        </p>
                    </div>
                </div>
                
                <!-- Input -->
                <div style="padding: 20px 24px; border-top: 1px solid var(--border-light); background: var(--bg-main);">
                    <div style="display: flex; gap: 12px; align-items: flex-end;">
                        <div style="flex: 1; position: relative;">
                            <textarea 
                                id="chatInput" 
                                placeholder="√âcrivez votre message..."
                                style="width: 100%; padding: 14px 16px; font-size: 0.9375rem; font-family: inherit; border: 2px solid var(--border); border-radius: var(--radius-md); resize: none; min-height: 52px; max-height: 150px; outline: none; transition: all var(--transition-fast);"
                                onkeydown="handleChatKeydown(event)"
                                onfocus="this.style.borderColor='var(--gold)'; this.style.boxShadow='0 0 0 3px rgba(212, 175, 55, 0.1)';"
                                onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none';"
                                oninput="autoResizeTextarea(this)"
                            ></textarea>
                        </div>
                        <button id="sendBtn" class="btn btn-primary" style="height: 52px; padding: 0 24px;" onclick="sendChatMessage()">
                            <span id="sendBtnText">Envoyer</span>
                            <span id="sendBtnLoader" style="display: none;">
                                <span style="display: inline-block; animation: spin 1s linear infinite;">‚è≥</span>
                            </span>
                        </button>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.75rem; color: var(--text-muted);">
                        Appuyez sur Entr√©e pour envoyer, Shift+Entr√©e pour un saut de ligne
                    </div>
                </div>
            </div>
        </div>
    `;
}

function initChatPage() {
    // Restaurer l'historique du chat
    renderChatHistory();
    
    // Focus sur l'input
    setTimeout(() => {
        const input = document.getElementById('chatInput');
        if (input) input.focus();
    }, 100);
}

function selectModule(moduleId) {
    APP.state.selectedModule = moduleId;
    APP.state.chatHistory = []; // Reset chat pour nouveau module
    renderPage('chat');
}

function autoResizeTextarea(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
}

function handleChatKeydown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendChatMessage();
    }
}

async function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message || APP.state.isTyping) return;
    
    const moduleId = APP.state.selectedModule;
    const module = SABRINA_MODULES.find(m => m.id === moduleId);
    
    if (!module) {
        showToast('error', 'Erreur', 'Module non trouv√©');
        return;
    }
    
    if (!module.active) {
        showToast('warning', 'Module inactif', 'Ce module n\'est pas actif. Activez-le dans les param√®tres.');
        return;
    }
    
    // Ajouter le message utilisateur
    addMessageToChat('user', message);
    input.value = '';
    input.style.height = '52px';
    
    // Afficher le loader
    APP.state.isTyping = true;
    updateSendButton(true);
    addTypingIndicator();
    
    try {
        const response = await SABRINA_API.sendMessage(message, moduleId);
        
        // Retirer le typing indicator
        removeTypingIndicator();
        
        // Ajouter la r√©ponse
        addMessageToChat('assistant', response, module);
        
    } catch (error) {
        removeTypingIndicator();
        addMessageToChat('error', `Erreur: ${error.message}`);
        showToast('error', 'Erreur de communication', error.message);
    } finally {
        APP.state.isTyping = false;
        updateSendButton(false);
    }
}

function addMessageToChat(type, content, module = null) {
    const messagesContainer = document.getElementById('chatMessages');
    
    // Retirer le message de bienvenue s'il existe
    const welcomeMsg = messagesContainer.querySelector('[data-welcome]');
    if (welcomeMsg) welcomeMsg.remove();
    
    const timestamp = new Date();
    
    // Sauvegarder dans l'historique
    APP.state.chatHistory.push({ type, content, timestamp, module: module?.id });
    
    const messageEl = document.createElement('div');
    messageEl.className = 'animate-slide-up';
    
    if (type === 'user') {
        messageEl.innerHTML = `
            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <div style="max-width: 70%; background: var(--bg-deep); color: var(--text-inverse); padding: 14px 18px; border-radius: var(--radius-lg) var(--radius-lg) 4px var(--radius-lg);">
                    <div style="font-size: 0.9375rem; line-height: 1.6;">${escapeHtml(content)}</div>
                    <div style="font-size: 0.6875rem; color: rgba(255,255,255,0.5); margin-top: 8px; text-align: right;">
                        ${formatDateTime(timestamp)}
                    </div>
                </div>
                <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--gold-gradient); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.875rem; color: var(--bg-deep); flex-shrink: 0;">
                    ${APP.state.currentUser.avatar}
                </div>
            </div>
        `;
    } else if (type === 'assistant') {
        const selectedModule = module || SABRINA_MODULES.find(m => m.id === APP.state.selectedModule);
        messageEl.innerHTML = `
            <div style="display: flex; gap: 12px;">
                <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--gold-light); display: flex; align-items: center; justify-content: center; font-size: 1.25rem; flex-shrink: 0;">
                    ${selectedModule?.icon || 'ü§ñ'}
                </div>
                <div style="max-width: 70%; background: var(--bg-card); border: 1px solid var(--border-light); padding: 14px 18px; border-radius: 4px var(--radius-lg) var(--radius-lg) var(--radius-lg); box-shadow: var(--shadow-sm);">
                    <div style="font-size: 0.9375rem; line-height: 1.7; color: var(--text-primary);">${formatMarkdown(content)}</div>
                    <div style="font-size: 0.6875rem; color: var(--text-muted); margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <span>${selectedModule?.name || 'SABRINA'}</span>
                        <span>${formatDateTime(timestamp)}</span>
                    </div>
                </div>
            </div>
        `;
    } else if (type === 'error') {
        messageEl.innerHTML = `
            <div style="display: flex; gap: 12px;">
                <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--danger-bg); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0;">‚ö†Ô∏è</div>
                <div style="max-width: 70%; background: var(--danger-bg); border: 1px solid var(--danger); padding: 14px 18px; border-radius: 4px var(--radius-lg) var(--radius-lg) var(--radius-lg);">
                    <div style="font-size: 0.9375rem; color: var(--danger);">${escapeHtml(content)}</div>
                </div>
            </div>
        `;
    }
    
    messagesContainer.appendChild(messageEl);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function addTypingIndicator() {
    const messagesContainer = document.getElementById('chatMessages');
    const selectedModule = SABRINA_MODULES.find(m => m.id === APP.state.selectedModule);
    
    const typingEl = document.createElement('div');
    typingEl.id = 'typingIndicator';
    typingEl.className = 'animate-fade';
    typingEl.innerHTML = `
        <div style="display: flex; gap: 12px;">
            <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--gold-light); display: flex; align-items: center; justify-content: center; font-size: 1.25rem; flex-shrink: 0;">
                ${selectedModule?.icon || 'ü§ñ'}
            </div>
            <div style="background: var(--bg-card); border: 1px solid var(--border-light); padding: 14px 18px; border-radius: 4px var(--radius-lg) var(--radius-lg) var(--radius-lg); box-shadow: var(--shadow-sm);">
                <div style="display: flex; gap: 4px;">
                    <span style="width: 8px; height: 8px; border-radius: 50%; background: var(--gold); animation: pulse 1s infinite;"></span>
                    <span style="width: 8px; height: 8px; border-radius: 50%; background: var(--gold); animation: pulse 1s infinite 0.2s;"></span>
                    <span style="width: 8px; height: 8px; border-radius: 50%; background: var(--gold); animation: pulse 1s infinite 0.4s;"></span>
                </div>
            </div>
        </div>
    `;
    
    messagesContainer.appendChild(typingEl);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function removeTypingIndicator() {
    const typingEl = document.getElementById('typingIndicator');
    if (typingEl) typingEl.remove();
}

function updateSendButton(loading) {
    const btn = document.getElementById('sendBtn');
    const text = document.getElementById('sendBtnText');
    const loader = document.getElementById('sendBtnLoader');
    
    if (loading) {
        btn.disabled = true;
        text.style.display = 'none';
        loader.style.display = 'inline';
    } else {
        btn.disabled = false;
        text.style.display = 'inline';
        loader.style.display = 'none';
    }
}

function renderChatHistory() {
    if (APP.state.chatHistory.length === 0) return;
    
    const messagesContainer = document.getElementById('chatMessages');
    if (!messagesContainer) return;
    
    // Clear welcome message
    messagesContainer.innerHTML = '';
    
    // Re-render messages
    APP.state.chatHistory.forEach(msg => {
        const module = msg.module ? SABRINA_MODULES.find(m => m.id === msg.module) : null;
        // Directly add without re-saving to history
        const messageEl = document.createElement('div');
        // ... (similar to addMessageToChat but without saving)
    });
}

function clearChat() {
    APP.state.chatHistory = [];
    renderPage('chat');
    showToast('info', 'Chat effac√©', 'L\'historique a √©t√© supprim√©');
}

async function testModule(moduleId) {
    showToast('info', 'Test en cours', 'V√©rification de la connexion...');
    
    const result = await SABRINA_API.testModule(moduleId);
    
    if (result.success) {
        showToast('success', 'Connexion OK', 'Le module r√©pond correctement');
    } else {
        showToast('error', '√âchec du test', result.error);
    }
}

// ============================================
// PAGE: MODULES IA
// ============================================

function renderModulesPage() {
    const categories = {
        general: { name: 'G√©n√©ral', icon: 'üåê' },
        business: { name: 'Business', icon: 'üíº' },
        direction: { name: 'Direction', icon: 'üëî' },
        metier: { name: 'M√©tier', icon: 'üõ†' },
        tools: { name: 'Outils', icon: '‚öôÔ∏è' },
        detected: { name: 'D√©tect√©s auto', icon: 'üÜï' }
    };
    
    const modulesByCategory = {};
    SABRINA_MODULES.forEach(m => {
        const cat = m.category || 'general';
        if (!modulesByCategory[cat]) modulesByCategory[cat] = [];
        modulesByCategory[cat].push(m);
    });
    
    return `
        <div class="page-header">
            <div class="page-header-left">
                <h1>Modules IA</h1>
                <p>${SABRINA_MODULES.filter(m => m.active).length} modules actifs sur ${SABRINA_MODULES.length}</p>
            </div>
            <div class="page-header-actions">
                <button class="btn btn-secondary" onclick="refreshData()">üîÑ Synchroniser</button>
                <button class="btn btn-primary" onclick="openModuleCreator()">‚ûï Cr√©er un module</button>
            </div>
        </div>
        
        ${Object.entries(modulesByCategory).map(([catKey, modules]) => {
            const cat = categories[catKey] || { name: catKey, icon: 'üì¶' };
            return `
                <div style="margin-bottom: 32px;">
                    <h2 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                        <span>${cat.icon}</span> ${cat.name}
                    </h2>
                    <div class="grid-3">
                        ${modules.map(m => `
                            <div class="card animate-slide-up" style="cursor: pointer; transition: all var(--transition-fast);"
                                 onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='var(--shadow-lg)';"
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-sm)';">
                                <div class="card-body">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                                        <div style="width: 56px; height: 56px; border-radius: var(--radius-lg); background: ${m.active ? 'var(--gold-light)' : 'var(--bg-main)'}; display: flex; align-items: center; justify-content: center; font-size: 1.75rem;">
                                            ${m.icon}
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            ${m.isNew ? '<span class="badge badge-info">Nouveau</span>' : ''}
                                            <label style="position: relative; display: inline-block; width: 44px; height: 24px;">
                                                <input type="checkbox" ${m.active ? 'checked' : ''} 
                                                       onchange="toggleModuleActive('${m.id}', this.checked)"
                                                       style="opacity: 0; width: 0; height: 0;">
                                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: ${m.active ? 'var(--success)' : 'var(--border)'}; transition: 0.3s; border-radius: 24px;">
                                                    <span style="position: absolute; content: ''; height: 18px; width: 18px; left: ${m.active ? '23px' : '3px'}; bottom: 3px; background-color: white; transition: 0.3s; border-radius: 50%;"></span>
                                                </span>
                                            </label>
                                        </div>
                                    </div>
                                    <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 4px;">${m.name}</h3>
                                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 16px;">${m.description}</p>
                                    
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;">
                                        <span class="badge badge-neutral" style="font-family: 'JetBrains Mono', monospace; font-size: 0.7rem;">/${m.path}</span>
                                        ${m.workflowId ? `<span class="badge badge-info" style="font-size: 0.7rem;">n8n #${m.workflowId.slice(0,8)}</span>` : ''}
                                    </div>
                                    
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn btn-ghost btn-sm" style="flex: 1;" onclick="APP.state.selectedModule='${m.id}'; navigateTo('chat');">
                                            üí¨ Chat
                                        </button>
                                        <button class="btn btn-ghost btn-sm" style="flex: 1;" onclick="testModule('${m.id}')">
                                            üîå Test
                                        </button>
                                        <button class="btn btn-ghost btn-sm" onclick="showModuleDetails('${m.id}')">
                                            ‚ãØ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }).join('')}
    `;
}

async function toggleModuleActive(moduleId, active) {
    const module = SABRINA_MODULES.find(m => m.id === moduleId);
    if (!module) return;
    
    if (module.workflowId) {
        try {
            if (active) {
                await N8N_API.activateWorkflow(module.workflowId);
            } else {
                await N8N_API.deactivateWorkflow(module.workflowId);
            }
        } catch (error) {
            // Revert UI change
            renderPage('modules');
            return;
        }
    } else {
        module.active = active;
        showToast('info', 'Module mis √† jour', `${module.name} est maintenant ${active ? 'actif' : 'inactif'}`);
    }
    
    renderPage('modules');
}

function showModuleDetails(moduleId) {
    const module = SABRINA_MODULES.find(m => m.id === moduleId);
    if (!module) return;
    
    openModal(module.name, `
        <div style="text-align: center; padding: 20px 0;">
            <div style="width: 80px; height: 80px; border-radius: var(--radius-xl); background: var(--gold-light); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; margin: 0 auto 16px;">
                ${module.icon}
            </div>
            <h3 style="font-size: 1.25rem; margin-bottom: 4px;">${module.name}</h3>
            <p style="color: var(--text-secondary);">${module.description}</p>
        </div>
        
        <div style="background: var(--bg-main); border-radius: var(--radius-md); padding: 16px; margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Webhook Path</div>
                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.875rem;">/${module.path}</div>
                </div>
                <div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Statut</div>
                    <span class="badge ${module.active ? 'badge-success' : 'badge-neutral'}">${module.active ? 'Actif' : 'Inactif'}</span>
                </div>
                <div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Cat√©gorie</div>
                    <div>${module.category || 'Non d√©finie'}</div>
                </div>
                <div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Workflow n8n</div>
                    <div>${module.workflowId ? '#' + module.workflowId.slice(0,8) : 'Non li√©'}</div>
                </div>
            </div>
        </div>
        
        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">URL compl√®te du webhook</div>
        <div style="background: var(--bg-deep); color: var(--gold); padding: 12px 16px; border-radius: var(--radius-md); font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; word-break: break-all;">
            ${N8N_CONFIG.webhookBase}/${module.path}
        </div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">Fermer</button>
        <button class="btn btn-primary" onclick="APP.state.selectedModule='${module.id}'; closeModal(); navigateTo('chat');">
            üí¨ Ouvrir le chat
        </button>
    `);
}

function openModuleCreator() {
    openModal('Cr√©er un nouveau module', `
        <p style="color: var(--text-secondary); margin-bottom: 24px;">
            Utilisez SABRINA Creator pour cr√©er un nouveau module IA personnalis√©.
        </p>
        
        <div class="form-group">
            <label class="form-label">Nom du module <span class="required">*</span></label>
            <input type="text" class="form-input" id="newModuleName" placeholder="Ex: SABRINA Juridique">
        </div>
        
        <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" id="newModuleDesc" placeholder="D√©crivez les capacit√©s du module..."></textarea>
        </div>
        
        <div class="form-group">
            <label class="form-label">Ic√¥ne (emoji)</label>
            <input type="text" class="form-input" id="newModuleIcon" placeholder="‚öñÔ∏è" maxlength="2">
        </div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">Annuler</button>
        <button class="btn btn-primary" onclick="createNewModule()">
            ‚öôÔ∏è Cr√©er avec SABRINA Creator
        </button>
    `);
}

async function createNewModule() {
    const name = document.getElementById('newModuleName').value.trim();
    const desc = document.getElementById('newModuleDesc').value.trim();
    const icon = document.getElementById('newModuleIcon').value.trim() || 'üÜï';
    
    if (!name) {
        showToast('error', 'Erreur', 'Le nom du module est requis');
        return;
    }
    
    closeModal();
    showToast('info', 'Cr√©ation en cours', 'SABRINA Creator pr√©pare votre module...');
    
    try {
        // Envoyer la commande √† SABRINA Creator
        const response = await SABRINA_API.sendMessage(
            `Cr√©e un nouveau module nomm√© "${name}" avec la description: ${desc || 'Module personnalis√©'}`,
            'creator'
        );
        
        showToast('success', 'Module cr√©√©', 'Rafra√Æchissez pour voir le nouveau module');
        
        // Rafra√Æchir les workflows
        await N8N_API.getWorkflows();
        renderPage('modules');
        
    } catch (error) {
        showToast('error', 'Erreur', 'Impossible de cr√©er le module: ' + error.message);
    }
}

// ============================================
// PAGE: WORKFLOWS N8N
// ============================================

function renderWorkflowsPage() {
    return `
        <div class="page-header">
            <div class="page-header-left">
                <h1>Workflows n8n</h1>
                <p>${APP.state.workflows.length} workflows d√©tect√©s - Derni√®re sync: ${APP.state.lastSync ? formatTimeAgo(APP.state.lastSync) : 'Jamais'}</p>
            </div>
            <div class="page-header-actions">
                <button class="btn btn-secondary" onclick="refreshData()">üîÑ Synchroniser</button>
                <a href="${N8N_CONFIG.baseUrl}" target="_blank" class="btn btn-primary">
                    üîß Ouvrir n8n
                </a>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <div class="card-title">Tous les workflows</div>
                <div style="display: flex; gap: 8px;">
                    <span class="badge badge-success">${APP.state.workflows.filter(w => w.active).length} actifs</span>
                    <span class="badge badge-neutral">${APP.state.workflows.filter(w => !w.active).length} inactifs</span>
                </div>
            </div>
            <div class="card-body" style="padding: 0;">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Workflow</th>
                                <th>Statut</th>
                                <th>ID</th>
                                <th>Cr√©√© le</th>
                                <th>Modifi√© le</th>
                                <th style="text-align: right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${APP.state.workflows.length > 0 ? APP.state.workflows.map(wf => `
                                <tr>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="width: 36px; height: 36px; border-radius: var(--radius-md); background: ${wf.name.toLowerCase().includes('sabrina') ? 'var(--gold-light)' : 'var(--bg-main)'}; display: flex; align-items: center; justify-content: center;">
                                                ${wf.name.toLowerCase().includes('sabrina') ? 'ü§ñ' : '‚öôÔ∏è'}
                                            </div>
                                            <div>
                                                <div style="font-weight: 600;">${wf.name}</div>
                                                ${wf.name.toLowerCase().includes('sabrina') ? '<span class="badge badge-gold" style="font-size: 0.65rem;">Module SABRINA</span>' : ''}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge ${wf.active ? 'badge-success' : 'badge-neutral'}">
                                            ${wf.active ? '‚óè Actif' : '‚óã Inactif'}
                                        </span>
                                    </td>
                                    <td style="font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--text-muted);">
                                        ${wf.id}
                                    </td>
                                    <td style="color: var(--text-secondary); font-size: 0.875rem;">
                                        ${wf.createdAt ? formatDate(wf.createdAt) : '-'}
                                    </td>
                                    <td style="color: var(--text-secondary); font-size: 0.875rem;">
                                        ${wf.updatedAt ? formatTimeAgo(wf.updatedAt) : '-'}
                                    </td>
                                    <td style="text-align: right;">
                                        <div style="display: flex; gap: 4px; justify-content: flex-end;">
                                            <button class="btn btn-ghost btn-sm" onclick="toggleWorkflow('${wf.id}', ${wf.active})" title="${wf.active ? 'D√©sactiver' : 'Activer'}">
                                                ${wf.active ? '‚è∏' : '‚ñ∂'}
                                            </button>
                                            <a href="${N8N_CONFIG.baseUrl}/workflow/${wf.id}" target="_blank" class="btn btn-ghost btn-sm" title="√âditer dans n8n">
                                                ‚úèÔ∏è
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            `).join('') : `
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 60px 20px;">
                                        <div style="font-size: 3rem; margin-bottom: 16px;">üîå</div>
                                        <h3 style="margin-bottom: 8px;">Aucun workflow trouv√©</h3>
                                        <p style="color: var(--text-secondary);">
                                            ${APP.state.n8nConnected 
                                                ? 'Cr√©ez votre premier workflow dans n8n' 
                                                : 'V√©rifiez la connexion √† n8n'}
                                        </p>
                                    </td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

// ============================================
// PAGE: CLIENTS (CRM)
// ============================================

// Sample data for demo
const SAMPLE_CLIENTS = [
    { id: 'c1', name: 'Marie Dupont', company: 'Entreprise SAS', email: 'marie@entreprise.fr', status: 'active', subscription: 'Premium', mrr: 299, modules: ['core', 'marketing', 'rh'], lastActivity: new Date(Date.now() - 3600000) },
    { id: 'c2', name: 'Jean Martin', company: 'Tech Solutions', email: 'jean@techsol.fr', status: 'active', subscription: 'Business', mrr: 199, modules: ['core', 'commercial'], lastActivity: new Date(Date.now() - 86400000) },
    { id: 'c3', name: 'Sophie Bernard', company: 'Formation Pro', email: 'sophie@formapro.fr', status: 'trial', subscription: 'Essai', mrr: 0, modules: ['core', 'formations'], lastActivity: new Date(Date.now() - 172800000) },
    { id: 'c4', name: 'Pierre Leroy', company: 'Consulting Plus', email: 'pierre@consplus.fr', status: 'pending', subscription: 'En attente', mrr: 0, modules: [], lastActivity: new Date(Date.now() - 604800000) },
];

function renderClientsPage() {
    APP.state.clients = SAMPLE_CLIENTS;
    const clients = APP.state.clients;
    
    const statusColors = {
        active: 'badge-success',
        trial: 'badge-warning',
        pending: 'badge-info',
        inactive: 'badge-neutral'
    };
    
    const statusLabels = {
        active: 'Actif',
        trial: 'Essai',
        pending: 'En attente',
        inactive: 'Inactif'
    };
    
    return `
        <div class="page-header">
            <div class="page-header-left">
                <h1>Gestion Clients</h1>
                <p>${clients.length} clients - MRR total: ${formatCurrency(clients.reduce((sum, c) => sum + c.mrr, 0))}</p>
            </div>
            <div class="page-header-actions">
                <button class="btn btn-secondary" onclick="exportClients()">üì• Exporter</button>
                <button class="btn btn-primary" onclick="openNewClientModal()">‚ûï Nouveau client</button>
            </div>
        </div>
        
        <!-- Stats -->
        <div class="grid-4" style="margin-bottom: 24px;">
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon green">üë•</div>
                </div>
                <div class="stat-card-value">${clients.filter(c => c.status === 'active').length}</div>
                <div class="stat-card-label">Clients actifs</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon gold">üí∞</div>
                </div>
                <div class="stat-card-value">${formatCurrency(clients.reduce((sum, c) => sum + c.mrr, 0))}</div>
                <div class="stat-card-label">MRR</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon blue">‚è≥</div>
                </div>
                <div class="stat-card-value">${clients.filter(c => c.status === 'trial').length}</div>
                <div class="stat-card-label">En essai</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon red">üìã</div>
                </div>
                <div class="stat-card-value">${clients.filter(c => c.status === 'pending').length}</div>
                <div class="stat-card-label">En attente</div>
            </div>
        </div>
        
        <!-- Liste clients -->
        <div class="card">
            <div class="card-header">
                <div style="display: flex; gap: 12px; align-items: center;">
                    <input type="text" class="form-input" placeholder="Rechercher un client..." style="width: 300px;" onkeyup="filterClients(this.value)">
                    <select class="form-select" style="width: 150px;" onchange="filterClientsByStatus(this.value)">
                        <option value="">Tous les statuts</option>
                        <option value="active">Actifs</option>
                        <option value="trial">En essai</option>
                        <option value="pending">En attente</option>
                    </select>
                </div>
            </div>
            <div class="card-body" style="padding: 0;">
                <div class="table-container">
                    <table class="table" id="clientsTable">
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th>Statut</th>
                                <th>Abonnement</th>
                                <th>MRR</th>
                                <th>Modules</th>
                                <th>Derni√®re activit√©</th>
                                <th style="text-align: right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${clients.map(client => `
                                <tr data-client-id="${client.id}" data-status="${client.status}">
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--gold-gradient); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--bg-deep);">
                                                ${client.name.split(' ').map(n => n[0]).join('')}
                                            </div>
                                            <div>
                                                <div style="font-weight: 600;">${client.name}</div>
                                                <div style="font-size: 0.8125rem; color: var(--text-secondary);">${client.company}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge ${statusColors[client.status]}">${statusLabels[client.status]}</span>
                                    </td>
                                    <td>${client.subscription}</td>
                                    <td style="font-weight: 600; color: var(--success);">${client.mrr > 0 ? formatCurrency(client.mrr) + '/mois' : '-'}</td>
                                    <td>
                                        <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                            ${client.modules.length > 0 ? client.modules.slice(0, 3).map(m => {
                                                const mod = SABRINA_MODULES.find(mod => mod.id === m);
                                                return mod ? `<span title="${mod.name}" style="font-size: 1rem;">${mod.icon}</span>` : '';
                                            }).join('') : '<span style="color: var(--text-muted);">-</span>'}
                                            ${client.modules.length > 3 ? `<span class="badge badge-neutral">+${client.modules.length - 3}</span>` : ''}
                                        </div>
                                    </td>
                                    <td style="color: var(--text-secondary); font-size: 0.875rem;">
                                        ${formatTimeAgo(client.lastActivity)}
                                    </td>
                                    <td style="text-align: right;">
                                        <div style="display: flex; gap: 4px; justify-content: flex-end;">
                                            <button class="btn btn-ghost btn-sm" onclick="viewClient('${client.id}')" title="Voir d√©tails">üëÅ</button>
                                            <button class="btn btn-ghost btn-sm" onclick="editClient('${client.id}')" title="Modifier">‚úèÔ∏è</button>
                                            <button class="btn btn-ghost btn-sm" onclick="messageClient('${client.id}')" title="Message">üí¨</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

function openNewClientModal() {
    openModal('Nouveau client', `
        <div class="form-group">
            <label class="form-label">Nom complet <span class="required">*</span></label>
            <input type="text" class="form-input" id="clientName" placeholder="Marie Dupont">
        </div>
        <div class="form-group">
            <label class="form-label">Entreprise</label>
            <input type="text" class="form-input" id="clientCompany" placeholder="Nom de l'entreprise">
        </div>
        <div class="form-group">
            <label class="form-label">Email <span class="required">*</span></label>
            <input type="email" class="form-input" id="clientEmail" placeholder="email@example.com">
        </div>
        <div class="form-group">
            <label class="form-label">T√©l√©phone</label>
            <input type="tel" class="form-input" id="clientPhone" placeholder="+33 6 12 34 56 78">
        </div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">Annuler</button>
        <button class="btn btn-primary" onclick="createClient()">Cr√©er le client</button>
    `);
}

function createClient() {
    const name = document.getElementById('clientName').value.trim();
    const email = document.getElementById('clientEmail').value.trim();
    
    if (!name || !email) {
        showToast('error', 'Erreur', 'Nom et email sont requis');
        return;
    }
    
    // Ajouter le client (demo)
    const newClient = {
        id: generateId(),
        name: name,
        company: document.getElementById('clientCompany').value.trim() || '',
        email: email,
        status: 'pending',
        subscription: 'En attente',
        mrr: 0,
        modules: [],
        lastActivity: new Date()
    };
    
    APP.state.clients.push(newClient);
    closeModal();
    showToast('success', 'Client cr√©√©', `${name} a √©t√© ajout√©`);
    renderPage('clients');
}

function viewClient(clientId) {
    const client = APP.state.clients.find(c => c.id === clientId);
    if (!client) return;
    
    openModal(`Fiche client: ${client.name}`, `
        <div style="display: flex; gap: 24px; margin-bottom: 24px;">
            <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--gold-gradient); display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 700; color: var(--bg-deep);">
                ${client.name.split(' ').map(n => n[0]).join('')}
            </div>
            <div>
                <h3 style="font-size: 1.25rem; margin-bottom: 4px;">${client.name}</h3>
                <p style="color: var(--text-secondary);">${client.company}</p>
                <p style="font-size: 0.875rem; color: var(--text-muted);">${client.email}</p>
            </div>
        </div>
        
        <div class="grid-2" style="gap: 16px; margin-bottom: 24px;">
            <div style="background: var(--bg-main); padding: 16px; border-radius: var(--radius-md);">
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Statut</div>
                <span class="badge ${client.status === 'active' ? 'badge-success' : 'badge-warning'}">${client.subscription}</span>
            </div>
            <div style="background: var(--bg-main); padding: 16px; border-radius: var(--radius-md);">
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">MRR</div>
                <div style="font-size: 1.25rem; font-weight: 700; color: var(--success);">${formatCurrency(client.mrr)}/mois</div>
            </div>
        </div>
        
        <div style="margin-bottom: 24px;">
            <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 12px;">Modules actifs</div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                ${client.modules.length > 0 ? client.modules.map(m => {
                    const mod = SABRINA_MODULES.find(mod => mod.id === m);
                    return mod ? `<span class="badge badge-gold">${mod.icon} ${mod.name.replace('SABRINA ', '')}</span>` : '';
                }).join('') : '<span style="color: var(--text-muted);">Aucun module actif</span>'}
            </div>
        </div>
        
        <div style="font-size: 0.875rem; color: var(--text-muted);">
            Derni√®re activit√©: ${formatTimeAgo(client.lastActivity)}
        </div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">Fermer</button>
        <button class="btn btn-secondary" onclick="closeModal(); navigateTo('audits');">üîç Lancer un audit</button>
        <button class="btn btn-primary" onclick="closeModal(); navigateTo('devis');">üìù Cr√©er un devis</button>
    `);
}

function filterClients(query) {
    const rows = document.querySelectorAll('#clientsTable tbody tr');
    const q = query.toLowerCase();
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(q) ? '' : 'none';
    });
}

function filterClientsByStatus(status) {
    const rows = document.querySelectorAll('#clientsTable tbody tr');
    
    rows.forEach(row => {
        if (!status || row.dataset.status === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// ============================================
// PAGE: PIPELINE COMMERCIAL
// ============================================

const SAMPLE_PIPELINE = [
    { id: 'p1', name: 'Tech Solutions', contact: 'Jean Martin', value: 2400, stage: 'lead', probability: 20, lastContact: new Date(Date.now() - 86400000) },
    { id: 'p2', name: 'Marketing Pro', contact: 'L√©a Simon', value: 1800, stage: 'qualification', probability: 40, lastContact: new Date(Date.now() - 172800000) },
    { id: 'p3', name: 'Formation Elite', contact: 'Marc Durand', value: 3200, stage: 'proposal', probability: 60, lastContact: new Date(Date.now() - 43200000) },
    { id: 'p4', name: 'Consulting Plus', contact: 'Pierre Leroy', value: 1500, stage: 'negotiation', probability: 80, lastContact: new Date(Date.now() - 7200000) },
    { id: 'p5', name: 'Digital Agency', contact: 'Emma Petit', value: 2800, stage: 'proposal', probability: 50, lastContact: new Date(Date.now() - 259200000) },
];

function renderPipelinePage() {
    const stages = {
        lead: { name: 'Leads', color: 'var(--info)', icon: 'üéØ' },
        qualification: { name: 'Qualification', color: 'var(--warning)', icon: 'üîç' },
        proposal: { name: 'Proposition', color: 'var(--gold)', icon: 'üìù' },
        negotiation: { name: 'N√©gociation', color: 'var(--success)', icon: 'ü§ù' },
        won: { name: 'Gagn√©', color: '#10B981', icon: '‚úÖ' },
        lost: { name: 'Perdu', color: 'var(--danger)', icon: '‚ùå' }
    };
    
    const pipeline = SAMPLE_PIPELINE;
    const pipelineByStage = {};
    Object.keys(stages).forEach(s => pipelineByStage[s] = []);
    pipeline.forEach(deal => {
        if (pipelineByStage[deal.stage]) {
            pipelineByStage[deal.stage].push(deal);
        }
    });
    
    const totalValue = pipeline.reduce((sum, d) => sum + d.value, 0);
    const weightedValue = pipeline.reduce((sum, d) => sum + (d.value * d.probability / 100), 0);
    
    return `
        <div class="page-header">
            <div class="page-header-left">
                <h1>Pipeline Commercial</h1>
                <p>${pipeline.length} opportunit√©s - ${formatCurrency(totalValue)} en pipeline</p>
            </div>
            <div class="page-header-actions">
                <button class="btn btn-secondary" onclick="navigateTo('audits')">üîç Nouvel audit</button>
                <button class="btn btn-primary" onclick="openNewDealModal()">‚ûï Nouvelle opportunit√©</button>
            </div>
        </div>
        
        <!-- Stats -->
        <div class="grid-4" style="margin-bottom: 32px;">
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon gold">üí∞</div>
                </div>
                <div class="stat-card-value">${formatCurrency(totalValue)}</div>
                <div class="stat-card-label">Pipeline total</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon green">üìä</div>
                </div>
                <div class="stat-card-value">${formatCurrency(weightedValue)}</div>
                <div class="stat-card-label">Valeur pond√©r√©e</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon blue">üéØ</div>
                </div>
                <div class="stat-card-value">${pipeline.length}</div>
                <div class="stat-card-label">Opportunit√©s</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon red">üìà</div>
                </div>
                <div class="stat-card-value">${Math.round(weightedValue / totalValue * 100)}%</div>
                <div class="stat-card-label">Taux moyen</div>
            </div>
        </div>
        
        <!-- Kanban Board -->
        <div style="display: flex; gap: 16px; overflow-x: auto; padding-bottom: 16px;">
            ${Object.entries(stages).slice(0, 4).map(([stageKey, stage]) => {
                const deals = pipelineByStage[stageKey] || [];
                const stageValue = deals.reduce((sum, d) => sum + d.value, 0);
                
                return `
                    <div style="min-width: 300px; flex: 1; background: var(--bg-main); border-radius: var(--radius-lg); padding: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.25rem;">${stage.icon}</span>
                                <span style="font-weight: 600;">${stage.name}</span>
                                <span class="badge badge-neutral">${deals.length}</span>
                            </div>
                            <span style="font-size: 0.875rem; font-weight: 600; color: ${stage.color};">${formatCurrency(stageValue)}</span>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${deals.length > 0 ? deals.map(deal => `
                                <div class="card" style="cursor: pointer; transition: all var(--transition-fast);"
                                     onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='var(--shadow-md)';"
                                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-sm)';"
                                     onclick="viewDeal('${deal.id}')">
                                    <div class="card-body" style="padding: 14px;">
                                        <div style="font-weight: 600; margin-bottom: 4px;">${deal.name}</div>
                                        <div style="font-size: 0.8125rem; color: var(--text-secondary); margin-bottom: 12px;">${deal.contact}</div>
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="font-weight: 700; color: var(--success);">${formatCurrency(deal.value)}</span>
                                            <span class="badge" style="background: ${stage.color}20; color: ${stage.color};">${deal.probability}%</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('') : `
                                <div style="text-align: center; padding: 24px; color: var(--text-muted); font-size: 0.875rem;">
                                    Aucune opportunit√©
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function openNewDealModal() {
    showToast('info', '√Ä venir', 'Cette fonctionnalit√© sera bient√¥t disponible');
}

function viewDeal(dealId) {
    const deal = SAMPLE_PIPELINE.find(d => d.id === dealId);
    if (!deal) return;
    
    showToast('info', deal.name, `Valeur: ${formatCurrency(deal.value)} - Contact: ${deal.contact}`);
}

// ============================================
// PAGE: AUDITS
// ============================================

const SAMPLE_AUDITS = [
    { id: 'a1', company: 'Tech Solutions', contact: 'Jean Martin', status: 'completed', score: 72, date: new Date(Date.now() - 86400000), modules: ['marketing', 'commercial', 'ceo'] },
    { id: 'a2', company: 'Formation Pro', contact: 'Sophie Bernard', status: 'in_progress', progress: 65, date: new Date(Date.now() - 3600000), modules: [] },
    { id: 'a3', company: 'Consulting Plus', contact: 'Pierre Leroy', status: 'pending', date: new Date(Date.now() - 172800000), modules: [] },
];

function renderAuditsPage() {
    const audits = SAMPLE_AUDITS;
    
    const statusConfig = {
        completed: { label: 'Termin√©', color: 'badge-success', icon: '‚úÖ' },
        in_progress: { label: 'En cours', color: 'badge-warning', icon: '‚è≥' },
        pending: { label: 'En attente', color: 'badge-neutral', icon: 'üìã' }
    };
    
    return `
        <div class="page-header">
            <div class="page-header-left">
                <h1>Centre d'Audits</h1>
                <p>${audits.length} audits - ${audits.filter(a => a.status === 'completed').length} termin√©s</p>
            </div>
            <div class="page-header-actions">
                <button class="btn btn-primary" onclick="startNewAudit()">‚ûï Nouvel audit</button>
            </div>
        </div>
        
        <!-- Stats -->
        <div class="grid-3" style="margin-bottom: 32px;">
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon green">‚úÖ</div>
                </div>
                <div class="stat-card-value">${audits.filter(a => a.status === 'completed').length}</div>
                <div class="stat-card-label">Audits termin√©s</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon gold">‚è≥</div>
                </div>
                <div class="stat-card-value">${audits.filter(a => a.status === 'in_progress').length}</div>
                <div class="stat-card-label">En cours</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon blue">üìä</div>
                </div>
                <div class="stat-card-value">${Math.round(audits.filter(a => a.score).reduce((sum, a) => sum + a.score, 0) / audits.filter(a => a.score).length) || 0}%</div>
                <div class="stat-card-label">Score moyen</div>
            </div>
        </div>
        
        <!-- Liste des audits -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">Tous les audits</div>
            </div>
            <div class="card-body" style="padding: 0;">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Entreprise</th>
                                <th>Contact</th>
                                <th>Statut</th>
                                <th>Score / Progression</th>
                                <th>Modules recommand√©s</th>
                                <th>Date</th>
                                <th style="text-align: right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${audits.map(audit => {
                                const status = statusConfig[audit.status];
                                return `
                                    <tr>
                                        <td style="font-weight: 600;">${audit.company}</td>
                                        <td>${audit.contact}</td>
                                        <td>
                                            <span class="badge ${status.color}">${status.icon} ${status.label}</span>
                                        </td>
                                        <td>
                                            ${audit.status === 'completed' 
                                                ? `<span style="font-weight: 700; color: ${audit.score >= 70 ? 'var(--success)' : audit.score >= 50 ? 'var(--warning)' : 'var(--danger)'};">${audit.score}%</span>`
                                                : audit.status === 'in_progress'
                                                    ? `<div style="display: flex; align-items: center; gap: 8px;">
                                                        <div style="flex: 1; height: 8px; background: var(--bg-main); border-radius: 4px; overflow: hidden;">
                                                            <div style="width: ${audit.progress}%; height: 100%; background: var(--gold);"></div>
                                                        </div>
                                                        <span style="font-size: 0.8rem;">${audit.progress}%</span>
                                                      </div>`
                                                    : '-'
                                            }
                                        </td>
                                        <td>
                                            ${audit.modules.length > 0 
                                                ? audit.modules.map(m => {
                                                    const mod = SABRINA_MODULES.find(mod => mod.id === m);
                                                    return mod ? `<span title="${mod.name}">${mod.icon}</span>` : '';
                                                }).join(' ')
                                                : '<span style="color: var(--text-muted);">-</span>'
                                            }
                                        </td>
                                        <td style="color: var(--text-secondary);">${formatDate(audit.date)}</td>
                                        <td style="text-align: right;">
                                            <div style="display: flex; gap: 4px; justify-content: flex-end;">
                                                ${audit.status === 'completed' 
                                                    ? `<button class="btn btn-ghost btn-sm" onclick="viewAuditReport('${audit.id}')">üìä Rapport</button>
                                                       <button class="btn btn-primary btn-sm" onclick="createDevisFromAudit('${audit.id}')">üìù Devis</button>`
                                                    : audit.status === 'in_progress'
                                                        ? `<button class="btn btn-primary btn-sm" onclick="continueAudit('${audit.id}')">‚ñ∂ Continuer</button>`
                                                        : `<button class="btn btn-ghost btn-sm" onclick="sendAuditReminder('${audit.id}')">üìß Relancer</button>`
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

function startNewAudit() {
    openModal('Nouvel audit', `
        <p style="color: var(--text-secondary); margin-bottom: 24px;">
            Lancez un audit complet pour analyser les besoins d'une entreprise et recommander les modules SABRINA adapt√©s.
        </p>
        
        <div class="form-group">
            <label class="form-label">Nom de l'entreprise <span class="required">*</span></label>
            <input type="text" class="form-input" id="auditCompany" placeholder="Ex: Tech Solutions">
        </div>
        
        <div class="form-group">
            <label class="form-label">Contact principal</label>
            <input type="text" class="form-input" id="auditContact" placeholder="Nom du contact">
        </div>
        
        <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="auditEmail" placeholder="email@entreprise.fr">
        </div>
        
        <div style="background: var(--info-bg); border-radius: var(--radius-md); padding: 16px; margin-top: 20px;">
            <div style="display: flex; gap: 12px;">
                <span style="font-size: 1.25rem;">üí°</span>
                <div>
                    <div style="font-weight: 600; margin-bottom: 4px;">Questionnaire V2 Premium</div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">
                        9 sections, 100+ questions, analyse automatique par SABRINA
                    </div>
                </div>
            </div>
        </div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">Annuler</button>
        <button class="btn btn-primary" onclick="launchAudit()">üöÄ Lancer l'audit</button>
    `);
}

function launchAudit() {
    const company = document.getElementById('auditCompany').value.trim();
    if (!company) {
        showToast('error', 'Erreur', 'Le nom de l\'entreprise est requis');
        return;
    }
    
    closeModal();
    showToast('success', 'Audit cr√©√©', `L'audit pour ${company} a √©t√© initialis√©`);
    
    // Ajouter l'audit √† la liste
    SAMPLE_AUDITS.unshift({
        id: generateId(),
        company: company,
        contact: document.getElementById('auditContact').value.trim() || 'Non d√©fini',
        status: 'in_progress',
        progress: 0,
        date: new Date(),
        modules: []
    });
    
    renderPage('audits');
}

function viewAuditReport(auditId) {
    showToast('info', 'Rapport', 'G√©n√©ration du rapport en cours...');
}

function createDevisFromAudit(auditId) {
    showToast('success', 'Devis', 'Redirection vers la cr√©ation de devis...');
    navigateTo('devis');
}

// ============================================
// PAGE: DEVIS
// ============================================

function renderDevisPage() {
    return `
        <div class="page-header">
            <div class="page-header-left">
                <h1>Gestion Devis</h1>
                <p>Cr√©ez et suivez vos devis clients</p>
            </div>
            <div class="page-header-actions">
                <button class="btn btn-primary" onclick="createNewDevis()">‚ûï Nouveau devis</button>
            </div>
        </div>
        
        <div class="grid-3" style="margin-bottom: 24px;">
            <div class="stat-card">
                <div class="stat-card-header"><div class="stat-card-icon gold">üìù</div></div>
                <div class="stat-card-value">8</div>
                <div class="stat-card-label">Devis envoy√©s</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header"><div class="stat-card-icon green">‚úÖ</div></div>
                <div class="stat-card-value">5</div>
                <div class="stat-card-label">Devis accept√©s</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header"><div class="stat-card-icon blue">üí∞</div></div>
                <div class="stat-card-value">${formatCurrency(12400)}</div>
                <div class="stat-card-label">Montant total</div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <div class="empty-state">
                    <div class="empty-state-icon">üìù</div>
                    <h3>Syst√®me de devis</h3>
                    <p>Cr√©ez des devis automatiquement √† partir des audits ou manuellement.</p>
                    <button class="btn btn-primary" style="margin-top: 20px;" onclick="createNewDevis()">
                        Cr√©er mon premier devis
                    </button>
                </div>
            </div>
        </div>
    `;
}

function createNewDevis() {
    showToast('info', '√Ä venir', 'Syst√®me de devis automatique en cours de d√©veloppement');
}

// ============================================
// PAGE: FACTURES
// ============================================

function renderFacturesPage() {
    return `
        <div class="page-header">
            <div class="page-header-left">
                <h1>Facturation</h1>
                <p>G√©rez vos factures et paiements</p>
            </div>
            <div class="page-header-actions">
                <button class="btn btn-primary" onclick="createNewFacture()">‚ûï Nouvelle facture</button>
            </div>
        </div>
        
        <div class="grid-4" style="margin-bottom: 24px;">
            <div class="stat-card">
                <div class="stat-card-header"><div class="stat-card-icon green">‚úÖ</div></div>
                <div class="stat-card-value">${formatCurrency(8500)}</div>
                <div class="stat-card-label">Pay√©es ce mois</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header"><div class="stat-card-icon gold">‚è≥</div></div>
                <div class="stat-card-value">${formatCurrency(2400)}</div>
                <div class="stat-card-label">En attente</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header"><div class="stat-card-icon red">‚ö†Ô∏è</div></div>
                <div class="stat-card-value">${formatCurrency(490)}</div>
                <div class="stat-card-label">En retard</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header"><div class="stat-card-icon blue">üìä</div></div>
                <div class="stat-card-value">95%</div>
                <div class="stat-card-label">Taux de recouvrement</div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <div class="empty-state">
                    <div class="empty-state-icon">üí≥</div>
                    <h3>Syst√®me de facturation</h3>
                    <p>G√©n√©rez et suivez vos factures automatiquement.</p>
                </div>
            </div>
        </div>
    `;
}

function createNewFacture() {
    showToast('info', '√Ä venir', 'Syst√®me de facturation en cours de d√©veloppement');
}

// ============================================
// PAGE: SETTINGS
// ============================================

function renderSettingsPage() {
    return `
        <div class="page-header">
            <div class="page-header-left">
                <h1>Param√®tres</h1>
                <p>Configuration de SABRINA Command Center</p>
            </div>
        </div>
        
        <div class="grid-2">
            <!-- Connexion n8n -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üîó Connexion n8n</div>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">URL n8n</label>
                        <input type="text" class="form-input" value="${N8N_CONFIG.baseUrl}" readonly style="background: var(--bg-main);">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cl√© API</label>
                        <input type="password" class="form-input" value="${N8N_CONFIG.apiKey.slice(0, 20)}..." readonly style="background: var(--bg-main);">
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: ${APP.state.n8nConnected ? 'var(--success-bg)' : 'var(--danger-bg)'}; border-radius: var(--radius-md);">
                        <span style="width: 10px; height: 10px; border-radius: 50%; background: ${APP.state.n8nConnected ? 'var(--success)' : 'var(--danger)'};"></span>
                        <span style="font-weight: 500; color: ${APP.state.n8nConnected ? 'var(--success)' : 'var(--danger)'};">
                            ${APP.state.n8nConnected ? 'Connect√©' : 'D√©connect√©'}
                        </span>
                        <span style="margin-left: auto; font-size: 0.875rem; color: var(--text-secondary);">
                            ${APP.state.workflows.length} workflows
                        </span>
                    </div>
                </div>
                <div class="card-footer">
                    <button class="btn btn-secondary" onclick="refreshData()">üîÑ Tester la connexion</button>
                </div>
            </div>
            
            <!-- Compte -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üë§ Mon compte</div>
                </div>
                <div class="card-body">
                    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                        <div style="width: 64px; height: 64px; border-radius: 50%; background: var(--gold-gradient); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 700; color: var(--bg-deep);">
                            ${APP.state.currentUser.avatar}
                        </div>
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 600;">${APP.state.currentUser.name}</div>
                            <div style="color: var(--text-secondary);">${APP.state.currentUser.email}</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">R√¥le</label>
                        <input type="text" class="form-input" value="${APP.state.currentUser.role === 'admin' ? 'Administrateur' : 'Client'}" readonly style="background: var(--bg-main);">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Entreprise</label>
                        <input type="text" class="form-input" value="${APP.state.currentUser.company}" readonly style="background: var(--bg-main);">
                    </div>
                </div>
                <div class="card-footer">
                    <button class="btn btn-danger" onclick="logout()">üö™ D√©connexion</button>
                </div>
            </div>
        </div>
    `;
}

// ============================================
// PAGES CLIENT
// ============================================

function renderClientDashboard() {
    const user = APP.state.currentUser;
    const accessibleModules = SABRINA_MODULES.filter(m => user.modulesAccess.includes(m.id));
    
    return `
        <div class="page-header">
            <div class="page-header-left">
                <h1>Bienvenue, ${user.name.split(' ')[0]} üëã</h1>
                <p>Votre espace client SABRINA</p>
            </div>
        </div>
        
        <div class="grid-2" style="margin-bottom: 32px;">
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon gold">‚≠ê</div>
                </div>
                <div class="stat-card-value">${user.subscription}</div>
                <div class="stat-card-label">Votre abonnement</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon blue">üß©</div>
                </div>
                <div class="stat-card-value">${accessibleModules.length}</div>
                <div class="stat-card-label">Modules actifs</div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <div class="card-title">Vos modules SABRINA</div>
            </div>
            <div class="card-body">
                <div class="grid-3">
                    ${accessibleModules.map(m => `
                        <div style="display: flex; align-items: center; gap: 16px; padding: 20px; background: var(--bg-main); border-radius: var(--radius-lg); cursor: pointer; transition: all var(--transition-fast);"
                             onmouseover="this.style.background='var(--gold-light)'"
                             onmouseout="this.style.background='var(--bg-main)'"
                             onclick="APP.state.selectedModule='${m.id}'; navigateTo('chat');">
                            <div style="width: 50px; height: 50px; border-radius: var(--radius-md); background: var(--bg-card); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                ${m.icon}
                            </div>
                            <div>
                                <div style="font-weight: 600;">${m.name}</div>
                                <div style="font-size: 0.8125rem; color: var(--text-secondary);">${m.description}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
}

function renderDocumentsPage() {
    return `
        <div class="page-header">
            <div class="page-header-left">
                <h1>Mes documents</h1>
                <p>Documents g√©n√©r√©s par SABRINA</p>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <div class="empty-state">
                    <div class="empty-state-icon">üìÅ</div>
                    <h3>Aucun document</h3>
                    <p>Les documents g√©n√©r√©s par SABRINA appara√Ætront ici.</p>
                </div>
            </div>
        </div>
    `;
}

function renderHistoriquePage() {
    return `
        <div class="page-header">
            <div class="page-header-left">
                <h1>Historique</h1>
                <p>Vos conversations avec SABRINA</p>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <div class="empty-state">
                    <div class="empty-state-icon">üìú</div>
                    <h3>Historique des conversations</h3>
                    <p>Retrouvez ici l'historique de vos √©changes avec SABRINA.</p>
                </div>
            </div>
        </div>
    `;
}

function renderSubscriptionPage() {
    const user = APP.state.currentUser;
    
    return `
        <div class="page-header">
            <div class="page-header-left">
                <h1>Mon abonnement</h1>
                <p>G√©rez votre formule SABRINA</p>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <div style="text-align: center; padding: 40px 0;">
                    <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--gold-gradient); display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 20px;">
                        ‚≠ê
                    </div>
                    <h2 style="font-size: 1.5rem; margin-bottom: 8px;">${user.subscription}</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 24px;">
                        ${user.modulesAccess.length} modules actifs
                    </p>
                    <button class="btn btn-primary">Upgrader mon abonnement</button>
                </div>
            </div>
        </div>
    `;
}

function renderSupportPage() {
    return `
        <div class="page-header">
            <div class="page-header-left">
                <h1>Support</h1>
                <p>Besoin d'aide ?</p>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <div style="text-align: center; padding: 40px 0;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üéß</div>
                    <h2 style="margin-bottom: 8px;">Contactez-nous</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 24px;">
                        Notre √©quipe est l√† pour vous aider
                    </p>
                    <div style="display: flex; gap: 16px; justify-content: center;">
                        <button class="btn btn-secondary">üìß Email</button>
                        <button class="btn btn-primary">üí¨ Chat en direct</button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function editClient(id) { showToast('info', '√âdition', 'Fonctionnalit√© √† venir'); }
function messageClient(id) { showToast('info', 'Message', 'Fonctionnalit√© √† venir'); }
function exportClients() { showToast('info', 'Export', 'Fonctionnalit√© √† venir'); }
function continueAudit(id) { showToast('info', 'Audit', 'Reprise de l\'audit...'); }
function sendAuditReminder(id) { showToast('success', 'Relance', 'Email de relance envoy√©'); }

// Fin du fichier - Application pr√™te !
console.log('‚úÖ SABRINA Command Center V1.0 - Charg√©');
</script>
</body>
</html>
